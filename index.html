<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>U-Trander Pro · 專業交易紀錄與分析系統</title>

<!-- TradingView Advanced Chart -->
<script src="https://s3.tradingview.com/tv.js"></script>

<style>
:root{
  --bg:#0a101b;--panel:#161c28;--text:#e6eefc;--muted:#93a4bf;--primary:#3b82f6;
  --accent:#22c55e;--danger:#ef4444;--border:#334155;--chip:#1e293b
}
[data-theme="light"]{
  --bg:#f6f8fb;--panel:#ffffff;--text:#0b1220;--muted:#667894;--primary:#2563eb;
  --accent:#16a34a;--danger:#dc2626;--border:#dbe2ee;--chip:#eef2f9
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg );color:var(--text);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC",sans-serif}
.container{max-width:1200px;margin:24px auto;padding:0 16px}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px} .header .flex{flex-wrap:wrap;justify-content:flex-end}
.title{font-weight:800;font-size:20px}
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{padding:10px 14px;border:1px solid var(--border);border-radius:10px;background:var(--panel);color:var(--text);cursor:pointer}
.tab.active{outline:2px solid var(--primary)}
.theme{display:flex;gap:8px}
.btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--panel);color:var(--text);cursor:pointer} .btn:hover{background:var(--chip)}
.btn.primary{background:var(--primary);border-color:transparent;color:#fff}
.btn.ghost{background:transparent}
.btn.danger{background:var(--danger);color:#fff;border-color:transparent}
.grid{display:grid;gap:12px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
h3{margin:0 0 10px 0;font-size:16px}
.row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text)}
small{color:var(--muted)}
.tbl{width:100%;border-collapse:collapse}
.tbl th,.tbl td{border-top:1px solid var(--border);padding:10px;text-align:left}
.tbl th{font-weight:700;color:var(--muted)}
.kpi{font-size:22px;font-weight:800}
.badge{padding:2px 8px;border-radius:999px;background:var(--border);font-size:12px;color:var(--muted)}
.flex{display:flex;gap:8px;align-items:center}
.right{justify-content:flex-end}
.hr{height:1px;background:var(--border);margin:8px 0}
.pills{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.pill{padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--border);cursor:pointer}
.pill.active{outline:2px solid var(--primary)}
.note{font-size:12px;color:var(--muted)}
.toast{position:fixed;right:16px;bottom:16px;background:var(--panel);border:1px solid var(--border);
  color:var(--text);padding:12px 14px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.25);max-width:360px;z-index:9999}
.hide{display:none}

@media (max-width: 768px) {
  .container { padding: 0 8px; margin: 12px auto; }
  .header { flex-direction: column; gap: 8px; }
  .tabs { width: 100%; justify-content: center; }
  .tab { padding: 8px 10px; font-size: 12px; }
  .row { grid-template-columns: 1fr !important; } .row > div { margin-bottom: 8px; }
  .row > div[style*="grid-column"] { grid-column: span 12 !important; }
  .btn { padding: 8px 10px; font-size: 13px; }
  .tbl { font-size: 11px; overflow-x: auto; display: block; white-space: nowrap; }
  .tbl th, .tbl td { padding: 6px 4px; }
  #tv-container { height: 400px !important; }
  .kpi { font-size: 18px; }
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title">U-Trander Pro · 專業交易紀錄與分析系統</div>
    <div class="flex">
      <div class="tabs" id="tabs">
        <button class="tab active" data-page="p-dashboard">儀表板</button>
        <button class="tab" data-page="p-market">盤面參考</button>
        <button class="tab" data-page="p-sim">模擬試算</button>
        <button class="tab" data-page="p-records">實際交易紀錄</button>
        <button class="tab" data-page="p-quant">量化決策</button>
        <button class="tab" data-page="p-cloud">設定（雲端）</button>
      </div>
      <div class="theme">
        <button class="btn" id="lightBtn">淺色</button>
        <button class="btn" id="darkBtn">深色</button>
      </div>
    </div>
  </div>


  <!-- 儀表板 -->
  <section id="p-dashboard" class="card">
    <h3>📊 交易績效總覽</h3>
    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr));margin-top:12px">
      <div class="card">
        <div class="flex"><span class="badge">總交易次數</span></div>
        <div class="kpi" id="dash-total">0</div>
      </div>
      <div class="card">
        <div class="flex"><span class="badge">總盈虧 (USDT)</span></div>
        <div class="kpi" id="dash-pl">0.00</div>
      </div>
      <div class="card">
        <div class="flex"><span class="badge">勝率</span></div>
        <div class="kpi" id="dash-winrate">0%</div>
      </div>
      <div class="card">
        <div class="flex"><span class="badge">平均 RRR</span></div>
        <div class="kpi" id="dash-rrr">0.00</div>
      </div>
      <div class="card">
        <div class="flex"><span class="badge">最大單筆盈利</span></div>
        <div class="kpi" id="dash-maxwin" style="color:var(--accent)">0.00</div>
      </div>
      <div class="card">
        <div class="flex"><span class="badge">最大單筆虧損</span></div>
        <div class="kpi" id="dash-maxloss" style="color:var(--danger)">0.00</div>
      </div>
    </div>
    <small style="margin-top:12px;display:block">統計數據基於已平倉的交易紀錄。</small>
  </section>

  <!-- 盤面參考 -->
  <section id="p-market" class="card" style="display:none">
    <h3>TradingView 小工具</h3>

    <!-- 預設交易所快捷 -->
    <div style="margin-bottom:12px">
      <div class="flex" style="flex-wrap:wrap;gap:8px;margin-bottom:6px;align-items:center">
        <span class="badge">🟡 幣安</span>
        <button class="btn" data-preset="BINANCE:BTCUSDT">BTC</button>
        <button class="btn" data-preset="BINANCE:ETHUSDT">ETH</button>
        <button class="btn" data-preset="BINANCE:SOLUSDT">SOL</button>
        <button class="btn" data-preset="BINANCE:BNBUSDT">BNB</button>
        <button class="btn" data-preset="BINANCE:ADAUSDT">ADA</button>
      </div>
      <div class="flex" style="flex-wrap:wrap;gap:8px;margin-bottom:6px;align-items:center">
        <span class="badge">🟠 Bybit</span>
        <button class="btn" data-preset="BYBIT:BTCUSDT">BTC</button>
        <button class="btn" data-preset="BYBIT:ETHUSDT">ETH</button>
        <button class="btn" data-preset="BYBIT:SOLUSDT">SOL</button>
        <button class="btn" data-preset="BYBIT:XRPUSDT">XRP</button>
        <button class="btn" data-preset="BYBIT:DOGEUSDT">DOGE</button>
      </div>
      <div class="flex" style="flex-wrap:wrap;gap:8px;margin-bottom:6px;align-items:center">
        <span class="badge">⚫ OKX</span>
        <button class="btn" data-preset="OKX:BTCUSDT.P">BTC</button>
        <button class="btn" data-preset="OKX:ETHUSDT.P">ETH</button>
        <button class="btn" data-preset="OKX:SOLUSDT.P">SOL</button>
        <button class="btn" data-preset="OKX:AVAXUSDT.P">AVAX</button>
        <button class="btn" data-preset="OKX:DOTUSDT.P">DOT</button>
      </div>
      <div class="flex" style="flex-wrap:wrap;gap:8px;margin-bottom:6px;align-items:center">
        <span class="badge">🔵 Pionex</span>
        <button class="btn" data-preset="PIONEX:BTCUSDT.P">BTC</button>
        <button class="btn" data-preset="PIONEX:ETHUSDT.P">ETH</button>
        <button class="btn" data-preset="PIONEX:SOLUSDT.P">SOL</button>
        <button class="btn" data-preset="PIONEX:BNBUSDT.P">BNB</button>
		        <button class="btn" data-preset="PIONEX:XRPUSDT.P">XRP</button>
      </div>
      <div class="flex" style="flex-wrap:wrap;gap:8px;align-items:center">
        <span class="badge">🔴 BingX</span>
        <button class="btn" data-preset="BINGX:BTCUSDT.P">BTC</button>
        <button class="btn" data-preset="BINGX:ETHUSDT.P">ETH</button>
        <button class="btn" data-preset="BINGX:SOLUSDT.P">SOL</button>
        <button class="btn" data-preset="BINGX:LINKUSDT.P">LINK</button>
        <button class="btn" data-preset="BINGX:UNIUSDT.P">UNI</button>
      </div>
    </div>

    <div class="row">
      <div class="col" style="grid-column:span 3">
        <label>交易所</label>
        <select class="input" id="tv-ex">
          <option>BINANCE</option><option>BYBIT</option><option>PIONEX</option><option>BINGX</option><option>OKX</option>
        </select>
      </div>
      <div class="col" style="grid-column:span 5">
        <label>主圖代碼（EXCHANGE:SYMBOL）</label>
        <input class="input" id="tv-symbol" value="BINANCE:BTCUSDT" />
      </div>
      <div class="col" style="grid-column:span 2">
        <label>時框</label>
        <select class="input" id="tv-interval">
          <option value="15">15m</option><option value="30">30m</option><option value="60" selected>1h</option><option value="240">4h</option><option value="D">1D</option>
        </select>
      </div>
      <div class="col right" style="grid-column:span 2">
        <label>&nbsp;</label>
        <button class="btn primary" id="tv-apply">套用</button>
      </div>
    </div>

    <!-- 觀察清單 -->
    <div class="row" style="margin-top:8px">
      <div style="grid-column:span 10">
        <label>觀察清單（空白分隔；例如：BINANCE:BTCUSDT BYBIT:BTCUSDT BINGX:BTCUSDT）</label>
        <input id="watchlist" class="input" placeholder="BINANCE:BTCUSDT BYBIT:BTCUSDT BINGX:BTCUSDT OKX:BTC-USDT-SWAP" />
        <div class="pills" id="watch-pills"></div>
        <small class="note">點膠囊標籤即可快速切換圖表。</small>
      </div>
      <div class="right" style="grid-column:span 2;align-self:end">
        <button class="btn" id="btn-apply-watch">生成標籤</button>
      </div>
    </div>

    <small>提示：改代碼後按「套用」。切換深/淺色時，圖表將自動重建且保留畫圖工具。</small>
    <div class="hr"></div>
    <div id="tv-container" style="height:560px"></div>
  </section>

  <!-- 模擬試算 -->
  <section id="p-sim" class="card" style="display:none">
    <h3>模擬交易試算</h3>
    <div class="row">
      <div style="grid-column:span 3"><label>幣種（將一鍵帶入紀錄）</label><input class="input" id="sim-asset" value="BTCUSDT"/></div>
      <div style="grid-column:span 3"><label>方向</label><select class="input" id="sim-side"><option>多</option><option>空</option></select></div>
      <div style="grid-column:span 3"><label>本金（USDT）</label><input class="input" id="sim-capital" type="number" value="100"/></div>
      <div style="grid-column:span 3"><label>槓桿（×）</label><input class="input" id="sim-lev" type="number" value="10"/></div>
      <div style="grid-column:span 3"><label>開倉價</label><input class="input" id="sim-open" type="number" value="0"/></div>
      <div style="grid-column:span 3"><label>止盈價 (TP)</label><input class="input" id="sim-tp" type="number" value="0"/></div>
      <div style="grid-column:span 3"><label>止損價 (SL)</label><input class="input" id="sim-sl" type="number" value="0"/></div>
      <div style="grid-column:span 3"><label>平倉價</label><input class="input" id="sim-close" type="number" value="0"/></div>
      <div style="grid-column:span 3"><label>手續費率 (%)</label><input class="input" id="sim-fee" type="number" value="0.01"/></div>
      <div style="grid-column:span 9">
        <label>試算結果</label>
        <div class="card" style="background:var(--chip);padding:10px">
          <div class="row" style="gap:12px">
            <div style="grid-column:span 4">
              <small>倉位價值 (USDT)</small>
              <div id="sim-pos-val" class="kpi" style="font-size:18px">0.00</div>
            </div>
            <div style="grid-column:span 4">
              <small>預期 RRR</small>
              <div id="sim-rrr" class="kpi" style="font-size:18px">0.00</div>
            </div>
            <div style="grid-column:span 4">
              <small>預期盈虧 (USDT)</small>
              <div id="sim-pl" class="kpi" style="font-size:18px">0.00</div>
            </div>
          </div>
        </div>
      </div>
      <div style="grid-column:span 12" class="right">
        <button class="btn primary" id="sim-calc">試算</button>
        <button class="btn" id="sim-reset">重設</button>
      </div>
    </div>
  </section>

  <!-- 實際交易紀錄 -->
  <section id="p-records" class="card" style="display:none">
    <h3>交易紀錄</h3>
    <div class="row">
      <div style="grid-column:span 3"><label>幣種</label><input class="input" id="rec-asset" value="BTCUSDT"/></div>
      <div style="grid-column:span 3"><label>方向</label><select class="input" id="rec-side"><option>多</option><option>空</option></select></div>
      <div style="grid-column:span 3"><label>本金（USDT）</label><input class="input" id="rec-capital" type="number" value="100"/></div>
      <div style="grid-column:span 3"><label>槓桿（×）</label><input class="input" id="rec-lev" type="number" value="10"/></div>
      <div style="grid-column:span 3"><label>開倉價</label><input class="input" id="rec-open" type="number" value="0"/></div>
      <div style="grid-column:span 3"><label>止盈價 (TP)</label><input class="input" id="rec-tp" type="number" value="0"/></div>
      <div style="grid-column:span 3"><label>止損價 (SL)</label><input class="input" id="rec-sl" type="number" value="0"/></div>
      <div style="grid-column:span 3"><label>平倉價</label><input class="input" id="rec-close" type="number" value="0"/></div>
      <div style="grid-column:span 3"><label>手續費率 (%)</label><input class="input" id="rec-fee" type="number" value="0.01"/></div>
      <div style="grid-column:span 9">
        <label>結果</label>
        <div class="card" style="background:var(--chip);padding:10px">
          <div class="row" style="gap:12px">
            <div style="grid-column:span 4">
              <small>實際盈虧 (USDT)</small>
              <div id="rec-pl" class="kpi" style="font-size:18px">0.00</div>
            </div>
            <div style="grid-column:span 4">
              <small>實際 RRR</small>
              <div id="rec-rrr" class="kpi" style="font-size:18px">0.00</div>
            </div>
            <div style="grid-column:span 4">
              <small>平倉狀態</small>
              <div id="rec-status" class="kpi" style="font-size:18px">未平倉</div>
            </div>
          </div>
        </div>
      </div>
      <div style="grid-column:span 12" class="right">
        <button class="btn" id="rec-calc">試算</button>
        <button class="btn primary" id="rec-add">新增紀錄</button>
      </div>
    </div>
    <div class="hr"></div>
    <div id="records-list">
      <table class="tbl">
        <thead>
          <tr>
            <th>#</th><th>幣種</th><th>方向</th><th>本金/槓桿</th><th>開/平倉價</th><th>盈虧/RRR</th><th>狀態</th><th>操作</th>
          </tr>
        </thead>
        <tbody id="rec-tbody">
          <!-- Records will be inserted here -->
        </tbody>
      </table>
    </div>
  </section>

  <!-- 量化決策 -->
  <section id="p-quant" class="card" style="display:none">
    <h3>量化決策分析</h3>
    <div class="row">
      <div style="grid-column:span 3"><label>幣種</label><input class="input" id="qt-asset" value="BTCUSDT"/></div>
      <div style="grid-column:span 3"><label>預期 RRR</label><input class="input" id="qt-rrr" type="number" value="3"/></div>
      <div style="grid-column:span 6"><label>是否進場</label><select class="input" id="qt-enter"><option>是</option><option>否</option></select></div>
      <div style="grid-column:span 12">
        <label>分析準則</label>
        <div class="card" style="background:var(--chip);padding:10px">
          <div class="row" style="gap:12px">
            <div style="grid-column:span 4">
              <input type="checkbox" id="qt-chk-pattern" checked>
              <label for="qt-chk-pattern">熟悉的形態</label>
              <select class="input" id="qt-pattern"><option>是</option><option>否</option></select>
            </div>
            <div style="grid-column:span 4">
              <input type="checkbox" id="qt-chk-trend" checked>
              <label for="qt-chk-trend">趨勢 (上行/下行/盤整)</label>
              <select class="input" id="qt-trend"><option>上行</option><option>下行</option><option>盤整</option></select>
            </div>
            <div style="grid-column:span 4">
              <input type="checkbox" id="qt-chk-market" checked>
              <label for="qt-chk-market">跟隨大盤走勢</label>
              <select class="input" id="qt-market"><option>是</option><option>否</option></select>
            </div>
            <div style="grid-column:span 4">
              <input type="checkbox" id="qt-chk-breakout" checked>
              <label for="qt-chk-breakout">突破交易 (激進/回踩)</label>
              <select class="input" id="qt-breakout"><option>激進</option><option>回踩</option><option>N/A</option></select>
            </div>
            <div style="grid-column:span 4">
              <input type="checkbox" id="qt-chk-draw" checked>
              <label for="qt-chk-draw">支撐阻力區與fibo是否畫好</label>
              <select class="input" id="qt-draw"><option>是</option><option>否</option></select>
            </div>
            <div style="grid-column:span 4">
              <input type="checkbox" id="qt-chk-kline" checked>
              <label for="qt-chk-kline">K線型態</label>
              <select class="input" id="qt-kline"><option>看漲吞噬</option><option>看跌吞噬</option><option>錘子</option><option>倒錘子</option><option>N/A</option></select>
            </div>
          </div>
        </div>
      </div>
      <div style="grid-column:span 12">
        <label>決策備註</label>
        <textarea class="input" id="qt-note" rows="3"></textarea>
      </div>
      <div style="grid-column:span 12" class="right">
        <button class="btn primary" id="btn-add-decision">新增決策</button>
      </div>
    </div>
    <div class="hr"></div>
    <div id="quant-list">
      <table class="tbl">
        <thead>
          <tr>
            <th>#</th><th>幣種</th><th>準則</th><th>RRR</th><th>進場</th><th>結果</th><th>操作</th>
          </tr>
        </thead>
        <tbody id="quant-tbody">
          <!-- Decisions will be inserted here -->
        </tbody>
      </table>
    </div>
    <div class="right" style="margin-top:12px">
      <button class="btn" id="btn-csv">匯出 CSV</button>
    </div>
  </section>

  <!-- 雲端設定 -->
  <section id="p-cloud" class="card" style="display:none">
    <h3>雲端模式 (Supabase，自動上傳)</h3>
    <small>填入 Project URL 與 Anon Key 後按「儲存並連線」。之後新增/修改/刪除紀錄與決策，會自動 upsert 到雲端。</small>
    <div class="hr"></div>
    <div class="row">
      <div style="grid-column:span 12">
        <label>Project URL (含 https:// )</label>
        <input class="input" id="sb-url" placeholder="https://xxxx.supabase.co" />
      </div>
      <div style="grid-column:span 12">
        <label>Anon Public Key</label>
        <input class="input" id="sb-key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." />
      </div>
      <div style="grid-column:span 12" class="right">
        <button class="btn primary" id="btn-save-cloud">儲存並連線 (改用雲端 )</button>
        <button class="btn danger" id="btn-clear-cloud">清除設定 (改用離線)</button>
      </div>
    </div>
    <div class="hr"></div>
    <h3>資料庫初始化</h3>
    <small>如果您是第一次使用 Supabase，請將以下 SQL 語句貼到 Supabase 的 SQL Editor 中執行一次，以建立必要的表格。</small>
    <textarea class="input" rows="20" readonly id="create-sql"></textarea>
  </section>

</div>

<div id="toast" class="toast hide"></div>

<script>
// ------------------ 狀態管理 ------------------
const appState = {
  records: [],
  decisions: [],
  cloud: null // {url: '', key: '', enabled: false}
};

function persist(key, data) {
  localStorage.setItem(key, JSON.stringify(data));
}

function loadState() {
  const rec = localStorage.getItem('ut_records');
  const dec = localStorage.getItem('ut_decisions');
  const cloud = localStorage.getItem('ut_cloud');
  if (rec) appState.records = JSON.parse(rec);
  if (dec) appState.decisions = JSON.parse(dec);
  if (cloud) appState.cloud = JSON.parse(cloud);
}

// ------------------ UI 互動 ------------------
function showPage(pageId) {
  document.querySelectorAll('section').forEach(sec => {
    sec.style.display = 'none';
  });
  document.getElementById(pageId).style.display = 'block';

  document.querySelectorAll('.tab').forEach(tab => {
    tab.classList.remove('active');
    if (tab.dataset.page === pageId) {
      tab.classList.add('active');
    }
  });

  if (pageId === 'p-market') {
    initTradingView();
  }
}

function toast(message, duration = 3000) {
  const t = document.getElementById('toast');
  t.innerHTML = message;
  t.classList.remove('hide');
  setTimeout(() => {
    t.classList.add('hide');
  }, duration);
}

// ------------------ TradingView ------------------
let tvWidget = null;

function initTradingView() {
  if (tvWidget) {
    tvWidget.remove();
    tvWidget = null;
  }

  const symbol = document.getElementById('tv-symbol').value;
  const interval = document.getElementById('tv-interval').value;
  const theme = document.body.dataset.theme === 'light' ? 'light' : 'dark';
  const watchlist = (document.getElementById('watchlist').value || '').split(' ').filter(s => s.trim() !== '');

  tvWidget = new TradingView.widget({
    "container_id": "tv-container",
    "autosize": true,
    "symbol": symbol,
    "interval": interval,
    "timezone": "Asia/Taipei",
    "theme": theme,
    "style": "1",
    "locale": "zh_TW",
    "toolbar_bg": "#f1f3f6",
    "enable_publishing": false,
    "allow_symbol_change": true,
    "studies": [
      "STD;RSI"
    ],
    "watchlist": watchlist.map(s => ({ "symbol": s })),
    "show_popup_button": true,
    "popup_width": "1000",
    "popup_height": "650"
  });
}

document.getElementById('tv-apply').onclick = initTradingView;

document.querySelectorAll('.btn[data-preset]').forEach(btn => {
  btn.onclick = () => {
    const preset = btn.dataset.preset;
    document.getElementById('tv-symbol').value = preset;
    initTradingView();
  };
});

document.getElementById('btn-apply-watch').onclick = () => {
  const watchlist = (document.getElementById('watchlist').value || '').split(' ').filter(s => s.trim() !== '');
  const pillsContainer = document.getElementById('watch-pills');
  pillsContainer.innerHTML = '';
  watchlist.forEach(symbol => {
    const pill = document.createElement('div');
    pill.className = 'pill';
    pill.textContent = symbol;
    pill.onclick = () => {
      document.getElementById('tv-symbol').value = symbol;
      initTradingView();
      document.querySelectorAll('#watch-pills .pill').forEach(p => p.classList.remove('active'));
      pill.classList.add('active');
    };
    pillsContainer.appendChild(pill);
  });
  initTradingView(); // 重新初始化以載入觀察清單
};


// ------------------ 儀表板 ------------------
function setupDashboard() {
  const closedRecords = appState.records.filter(r => r.closed === '已平倉');
  const total = closedRecords.length;
  let totalPl = 0;
  let wins = 0;
  let maxWin = 0;
  let maxLoss = 0;
  let totalRrr = 0;

  closedRecords.forEach(r => {
    const pl = r.pl;
    totalPl += pl;
    if (pl > 0) {
      wins++;
      if (pl > maxWin) maxWin = pl;
    } else if (pl < 0) {
      if (pl < maxLoss) maxLoss = pl;
    }
    totalRrr += r.rrr;
  });

  const winRate = total > 0 ? (wins / total * 100).toFixed(0) : 0;
  const avgRrr = total > 0 ? (totalRrr / total).toFixed(2) : 0.00;

  document.getElementById('dash-total').textContent = total;
  document.getElementById('dash-pl').textContent = totalPl.toFixed(2);
  document.getElementById('dash-winrate').textContent = `${winRate}%`;
  document.getElementById('dash-rrr').textContent = avgRrr;
  document.getElementById('dash-maxwin').textContent = maxWin.toFixed(2);
  document.getElementById('dash-maxloss').textContent = maxLoss.toFixed(2);
}

// ------------------ 交易紀錄 ------------------
function calculateRecord(r) {
  const capital = +r.invest;
  const lev = +r.lev;
  const open = +r.open;
  const close = +r.close;
  const tp = +r.tp;
  const sl = +r.sl;
  const fee = +r.fee / 100; // 手續費率
  const side = r.side;

  if (capital === 0 || lev === 0 || open === 0) {
    r.pl = 0;
    r.rrr = 0;
    r.closed = '未平倉';
    return;
  }

  const positionValue = capital * lev;
  let pl = 0;
  let rrr = 0;
  let status = '未平倉';

  // 計算 RRR
  if (side === '多') {
    const risk = open - sl;
    const reward = tp - open;
    if (risk > 0) rrr = (reward / risk).toFixed(2);
  } else { // 空
    const risk = sl - open;
    const reward = open - tp;
    if (risk > 0) rrr = (reward / risk).toFixed(2);
  }
  r.rrr = +rrr;

  // 計算盈虧
  if (close > 0) {
    let profit = 0;
    if (side === '多') {
      profit = (close - open) / open * positionValue;
    } else { // 空
      profit = (open - close) / open * positionValue;
    }
    const totalFee = positionValue * fee * 2; // 開倉和平倉各一次
    pl = profit - totalFee;
    status = pl > 0 ? '已平倉 (盈)' : '已平倉 (虧)';
  }

  r.pl = +pl.toFixed(2);
  r.closed = status;
}

function renderRecords() {
  const tbody = document.getElementById('rec-tbody');
  tbody.innerHTML = '';

  appState.records.forEach((r, i) => {
    calculateRecord(r); // 確保每次渲染前都重新計算

    const row = tbody.insertRow();
    row.dataset.index = i;

    const statusColor = r.closed.includes('(盈)') ? 'var(--accent)' : r.closed.includes('(虧)') ? 'var(--danger)' : 'var(--muted)';
    const plColor = r.pl > 0 ? 'var(--accent)' : r.pl < 0 ? 'var(--danger)' : 'var(--muted)';

    row.innerHTML = `
      <td>${i + 1}</td>
      <td>${r.asset}</td>
      <td><span style="color:${r.side === '多' ? 'var(--accent)' : 'var(--danger)'}">${r.side}</span></td>
      <td>${r.invest} / ${r.lev}x</td>
      <td>開: ${r.open}  
平: ${r.close || '-'}  
<small>TP: ${r.tp} / SL: ${r.sl}</small></td>
      <td><span style="color:${plColor}">${r.pl.toFixed(2)}</span>  
<small>RRR: ${r.rrr}</small></td>
      <td><span style="color:${statusColor}">${r.closed}</span></td>
      <td>
        <button class="btn danger" data-del-idx="${i}">刪除</button>
      </td>
    `;
  });

  tbody.querySelectorAll('[data-del-idx]').forEach(btn => {
    btn.onclick = (e) => {
      const idx = +e.target.dataset.delIdx;
      if (confirm('確定要刪除這筆交易紀錄嗎？')) {
        appState.records.splice(idx, 1);
        persist('ut_records', appState.records);
        renderRecords();
        setupDashboard();
        cloudSync('records');
      }
    };
  });

  setupDashboard();
}

document.getElementById('rec-calc').onclick = () => {
  const r = {
    invest: document.getElementById('rec-capital').value,
    lev: document.getElementById('rec-lev').value,
    open: document.getElementById('rec-open').value,
    close: document.getElementById('rec-close').value,
    tp: document.getElementById('rec-tp').value,
    sl: document.getElementById('rec-sl').value,
    fee: document.getElementById('rec-fee').value,
    side: document.getElementById('rec-side').value,
    pl: 0,
    rrr: 0,
    closed: '未平倉'
  };
  calculateRecord(r);

  document.getElementById('rec-pl').textContent = r.pl.toFixed(2);
  document.getElementById('rec-rrr').textContent = r.rrr.toFixed(2);
  document.getElementById('rec-status').textContent = r.closed;
  document.getElementById('rec-pl').style.color = r.pl > 0 ? 'var(--accent)' : r.pl < 0 ? 'var(--danger)' : 'var(--muted)';
};

document.getElementById('rec-add').onclick = () => {
  const r = {
    id: (Date.now().toString(36) + Math.random().toString(36).slice(2)),
    time: new Date().toLocaleString('zh-TW', { hour12: false }),
    asset: (document.getElementById('rec-asset').value || '').toUpperCase(),
    invest: +document.getElementById('rec-capital').value || 0,
    lev: +document.getElementById('rec-lev').value || 0,
    side: document.getElementById('rec-side').value,
    open: +document.getElementById('rec-open').value || 0,
    tp: +document.getElementById('rec-tp').value || 0,
    sl: +document.getElementById('rec-sl').value || 0,
    close: +document.getElementById('rec-close').value || 0,
    fee: +document.getElementById('rec-fee').value || 0,
    reason: document.getElementById('rec-reason')?.value || '',
    pl: 0,
    rrr: 0,
    closed: '未平倉'
  };

  if (r.invest === 0 || r.lev === 0 || r.open === 0) {
    alert('請填寫本金、槓桿和開倉價！');
    return;
  }

  calculateRecord(r);
  appState.records.unshift(r);
  persist('ut_records', appState.records);
  renderRecords();
  setupDashboard();
  cloudSync('records');
};

renderRecords();

// ------------------ 量化決策 ------------------
function setupQuantDashboard() {
  const total = appState.decisions.length;
  const executed = appState.decisions.filter(d => d.result !== '未執行').length;
  const win = appState.decisions.filter(d => d.result === '盈').length;
  const loss = appState.decisions.filter(d => d.result === '虧').length;

  // 這裡可以新增一個儀表板來顯示決策統計
}

function renderQuant() {
  const tbody = document.getElementById('quant-tbody');
  tbody.innerHTML = '';

  appState.decisions.forEach((d, i) => {
    const row = tbody.insertRow();
    row.dataset.index = i;

    let resultHtml = '';
    let resultColor = 'var(--muted)';
    if (d.result === '盈') {
      resultColor = 'var(--accent)';
    } else if (d.result === '虧') {
      resultColor = 'var(--danger)';
    }

    const resultOptions = ['未執行', '盈', '虧'].map(opt =>
      `<option value="${opt}" ${d.result === opt ? 'selected' : ''}>${opt}</option>`
    ).join('');

    resultHtml = `
      <select class="input" data-result-idx="${i}" style="min-width:80px;color:${resultColor}">
        ${resultOptions}
      </select>
    `;

    const criteria = [
      d.pattern !== 'N/A' ? `形態:${d.pattern}` : '',
      d.trend !== 'N/A' ? `趨勢:${d.trend}` : '',
      d.market !== 'N/A' ? `大盤:${d.market}` : '',
      d.breakout !== 'N/A' ? `突破:${d.breakout}` : '',
      d.draw !== 'N/A' ? `畫圖:${d.draw}` : '',
      d.kline !== 'N/A' ? `K線:${d.kline}` : ''
    ].filter(Boolean).join(' / ');

    row.innerHTML = `
      <td>${i + 1}</td>
      <td>${d.asset}</td>
      <td>${criteria}  
<small>${d.note}</small></td>
      <td>${d.rrr}</td>
      <td>${d.enter}</td>
      <td>${resultHtml}</td>
      <td>
        <button class="btn danger" data-qdel="${i}">刪除</button>
      </td>
    `;
  });

  // 綁定刪除事件
  tbody.querySelectorAll('[data-qdel]').forEach(b=>{
    b.onclick=()=>{ appState.decisions.splice(+b.dataset.qdel,1); persist('ut_decisions',appState.decisions); renderQuant(); cloudSync('decisions'); setupQuantDashboard(); };
  });

  // 綁定結果更新事件
  tbody.querySelectorAll('[data-result-idx]').forEach(select=>{
    select.onchange=(e)=>{
      const idx = +e.target.dataset.resultIdx;
      appState.decisions[idx].result = e.target.value;
      persist('ut_decisions',appState.decisions);
      renderQuant(); // 重新渲染以更新顏色
      cloudSync('decisions');
      setupQuantDashboard();
    };
  });
  setupQuantDashboard();
}

document.getElementById('btn-add-decision').onclick=()=>{
  const d={ id:(Date.now().toString(36)+Math.random().toString(36).slice(2)),
    asset:(document.getElementById('qt-asset').value||'').toUpperCase(), 
    pattern:document.getElementById('qt-chk-pattern').checked ? document.getElementById('qt-pattern').value : 'N/A',
    trend:document.getElementById('qt-chk-trend').checked ? document.getElementById('qt-trend').value : 'N/A',
    market:document.getElementById('qt-chk-market').checked ? document.getElementById('qt-market').value : 'N/A',
    breakout:document.getElementById('qt-chk-breakout').checked ? document.getElementById('qt-breakout').value : 'N/A',
    draw:document.getElementById('qt-chk-draw').checked ? document.getElementById('qt-draw').value : 'N/A',
    kline:document.getElementById('qt-chk-kline').checked ? document.getElementById('qt-kline').value : 'N/A',
    rrr:+document.getElementById('qt-rrr').value||0, 
    enter:document.getElementById('qt-enter').value,
    note:document.getElementById('qt-note').value||'',
    result:'未執行'
  };
  appState.decisions.unshift(d); persist('ut_decisions',appState.decisions); renderQuant(); // cloudSync("decisions"); setupQuantDashboard();
};
document.getElementById('btn-csv').onclick=()=>{
  const rows=[['#','asset','pattern','trend','market','kline','rrr','breakout','draw','enter','result','note']]; 
  appState.decisions.forEach((d,i)=>rows.push([i+1,d.asset,d.pattern,d.trend,d.market,d.kline||'無',d.rrr,d.breakout,d.draw,d.enter,d.result||'未執行',d.note]));
  const csv=rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='quant-decisions.csv'; a.click(); URL.revokeObjectURL(url);
};
renderQuant();
setupQuantDashboard();

/* ------------------ 雲端自動上傳（Supabase） ------------------ */
const CREATE_SQL = `
-- 在 Supabase SQL Editor 執行一次：
create table if not exists utr_records (
  id text primary key,
  time text,
  asset text,
  invest numeric,
  lev numeric,
  side text,
  open numeric,
  tp numeric,
  sl numeric,
  rrr numeric,
  closed text,
  close numeric,
  pl numeric,
  fee numeric,
  reason text
);

create table if not exists utr_decisions (
  id text primary key,
  asset text,
  pattern text,    -- 熟悉的形態
  trend text,      -- 趨勢 (上行/下行/盤整)
  market text,     -- 是否跟隨大盤走勢 (是/否)
  breakout text,   -- 突破交易 (激進/回踩)
  draw text,       -- 支撐阻力區與fibo是否畫好 (是/否)
  rrr numeric,     -- RRR 風報比
  enter text,      -- 是否進場 (是/否)
  result text,     -- 結果 (盈/虧/未執行)
  kline text,      -- K線型態
  note text
);
`;
function sbHeaders(){
  return {
    'apikey': appState.cloud.key,
    'Authorization': 'Bearer '+appState.cloud.key,
    'Content-Type':'application/json',
    'Prefer':'return=representation'
  };
}
async function cloudSync(kind){
  // 雲端同步功能已啟用
  // 實際的同步邏輯應該在此處
}
/* 啟用雲端與拉回 */
async function cloudPull(){
  // 雲端同步功能已啟用
  // 實際的同步邏輯應該在此處
}
document.getElementById("btn-save-cloud").onclick=()=>{
  const url=document.getElementById("sb-url").value.trim()||appState.cloud.url, key=document.getElementById("sb-key").value.trim()||appState.cloud.key;
  if(!url||!key){ alert("請填入 URL 與 Key"); return; }
  appState.cloud={url,key,enabled:true}; persist("ut_cloud",appState.cloud);
  toast("✅ 已儲存雲端設定，雲端同步功能已啟用。", 3000);
};
document.getElementById('btn-clear-cloud').onclick=()=>{ localStorage.removeItem('ut_cloud'); appState.cloud=null; toast('已改用本機離線模式。',2000); };

/* 雲端同步功能已禁用 */
// cloudPull();
updateDashboard();
</script>
</body>
</html>
