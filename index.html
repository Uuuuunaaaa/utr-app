<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>U-Trander Pro Â· å°ˆæ¥­äº¤æ˜“ç´€éŒ„èˆ‡åˆ†æç³»çµ±</title>

<!-- TradingView Advanced Chart -->
<script src="https://s3.tradingview.com/tv.js"></script>

<!-- Supabase JS Client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#0a101b;--panel:#161c28;--text:#e6eefc;--muted:#93a4bf;--primary:#3b82f6;
  --accent:#22c55e;--danger:#ef4444;--border:#334155;--chip:#1e293b
}
[data-theme="light"]{
  --bg:#f6f8fb;--panel:#ffffff;--text:#0b1220;--muted:#667894;--primary:#2563eb;
  --accent:#16a34a;--danger:#dc2626;--border:#dbe2ee;--chip:#eef2f9
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC",sans-serif}
.container{max-width:1200px;margin:24px auto;padding:0 16px}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px} .header .flex{flex-wrap:wrap;justify-content:flex-end}
.title{font-weight:800;font-size:20px}
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{padding:10px 14px;border:1px solid var(--border);border-radius:10px;background:var(--panel);color:var(--text);cursor:pointer}
.tab.active{outline:2px solid var(--primary)}
.theme{display:flex;gap:8px}
.btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--panel);color:var(--text);cursor:pointer} .btn:hover{background:var(--chip)}
.btn.primary{background:var(--primary);border-color:transparent;color:#fff}
.btn.ghost{background:transparent}
.btn.danger{background:var(--danger);color:#fff;border-color:transparent}
.grid{display:grid;gap:12px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
h3{margin:0 0 10px 0;font-size:16px}
.row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text)}
small{color:var(--muted)}
.tbl{width:100%;border-collapse:collapse}
.tbl th,.tbl td{border-top:1px solid var(--border);padding:10px;text-align:left}
.tbl th{font-weight:700;color:var(--muted)}
.kpi{font-size:22px;font-weight:800}
.badge{padding:2px 8px;border-radius:999px;background:var(--border);font-size:12px;color:var(--muted)}
.flex{display:flex;gap:8px;align-items:center}
.right{justify-content:flex-end}
.hr{height:1px;background:var(--border);margin:8px 0}
.pills{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.pill{padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--border);cursor:pointer}
.pill.active{outline:2px solid var(--primary)}
.note{font-size:12px;color:var(--muted)}
.toast{position:fixed;right:16px;bottom:16px;background:var(--panel);border:1px solid var(--border);
  color:var(--text);padding:12px 14px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.25);max-width:360px;z-index:9999}
.hide{display:none}
.sync-badge{display:inline-block;padding:4px 8px;border-radius:6px;font-size:11px;font-weight:600;margin-left:8px}
.sync-badge.synced{background:var(--accent);color:#fff}
.sync-badge.syncing{background:var(--primary);color:#fff;animation:pulse 1s infinite}
.sync-badge.error{background:var(--danger);color:#fff}
@keyframes pulse{0%,100%{opacity:0.7}50%{opacity:1}}

@media (max-width: 768px) {
  .container { padding: 0 8px; margin: 12px auto; }
  .header { flex-direction: column; gap: 8px; }
  .tabs { width: 100%; justify-content: center; }
  .tab { padding: 8px 10px; font-size: 12px; }
  .row { grid-template-columns: 1fr !important; } .row > div { margin-bottom: 8px; }
  .row > div[style*="grid-column"] { grid-column: span 12 !important; }
  .btn { padding: 8px 10px; font-size: 13px; }
  .tbl { font-size: 11px; overflow-x: auto; display: block; white-space: nowrap; }
  .tbl th, .tbl td { padding: 6px 4px; }
  #tv-container { height: 400px !important; }
  .kpi { font-size: 18px; }
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title">U-Trander Pro Â· å°ˆæ¥­äº¤æ˜“ç´€éŒ„èˆ‡åˆ†æç³»çµ± <span class="sync-badge" id="sync-status">åˆå§‹åŒ–ä¸­</span></div>
    <div class="flex">
      <div class="tabs" id="tabs">
        <button class="tab active" data-page="p-dashboard">å„€è¡¨æ¿</button>
        <button class="tab" data-page="p-market">ç›¤é¢åƒè€ƒ</button>
        <button class="tab" data-page="p-sim">æ¨¡æ“¬è©¦ç®—</button>
        <button class="tab" data-page="p-records">å¯¦éš›äº¤æ˜“ç´€éŒ„</button>
        <button class="tab" data-page="p-quant">é‡åŒ–æ±ºç­–</button>
        <button class="tab" data-page="p-cloud">è¨­å®šï¼ˆé›²ç«¯ï¼‰</button>
      </div>
      <div class="theme">
        <button class="btn" id="lightBtn">æ·ºè‰²</button>
        <button class="btn" id="darkBtn">æ·±è‰²</button>
      </div>
    </div>
  </div>


  <!-- å„€è¡¨æ¿ -->
  <section id="p-dashboard" class="card">
    <h3>ğŸ“Š äº¤æ˜“ç¸¾æ•ˆç¸½è¦½</h3>
    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr));margin-top:12px">
      <div class="card">
        <div class="flex"><span class="badge">ç¸½äº¤æ˜“æ¬¡æ•¸</span></div>
        <div class="kpi" id="dash-total">0</div>
      </div>
      <div class="card">
        <div class="flex"><span class="badge">ç¸½ç›ˆè™§ (USDT)</span></div>
        <div class="kpi" id="dash-pl">0.00</div>
      </div>
      <div class="card">
        <div class="flex"><span class="badge">å‹ç‡</span></div>
        <div class="kpi" id="dash-winrate">0%</div>
      </div>
      <div class="card">
        <div class="flex"><span class="badge">å¹³å‡ RRR</span></div>
        <div class="kpi" id="dash-rrr">0.00</div>
      </div>
      <div class="card">
        <div class="flex"><span class="badge">æœ€å¤§å–®ç­†ç›ˆåˆ©</span></div>
        <div class="kpi" id="dash-maxwin" style="color:var(--accent)">0.00</div>
      </div>
      <div class="card">
        <div class="flex"><span class="badge">æœ€å¤§å–®ç­†è™§æ</span></div>
        <div class="kpi" id="dash-maxloss" style="color:var(--danger)">0.00</div>
      </div>
    </div>
    <small style="margin-top:12px;display:block">çµ±è¨ˆæ•¸æ“šåŸºæ–¼å·²å¹³å€‰çš„äº¤æ˜“ç´€éŒ„ã€‚</small>
  </section>

  <!-- ç›¤é¢åƒè€ƒ -->
  <section id="p-market" class="card" style="display:none">
    <h3>TradingView å°å·¥å…·</h3>

    <!-- é è¨­äº¤æ˜“æ‰€å¿«æ· -->
    <div style="margin-bottom:12px">
      <div class="flex" style="flex-wrap:wrap;gap:8px;margin-bottom:6px;align-items:center">
        <span class="badge">ğŸŸ¡ å¹£å®‰</span>
        <button class="btn" data-preset="BINANCE:BTCUSDT">BTC</button>
        <button class="btn" data-preset="BINANCE:ETHUSDT">ETH</button>
        <button class="btn" data-preset="BINANCE:SOLUSDT">SOL</button>
        <button class="btn" data-preset="BINANCE:BNBUSDT">BNB</button>
        <button class="btn" data-preset="BINANCE:ADAUSDT">ADA</button>
      </div>
      <div class="flex" style="flex-wrap:wrap;gap:8px;margin-bottom:6px;align-items:center">
        <span class="badge">ğŸŸ  Bybit</span>
        <button class="btn" data-preset="BYBIT:BTCUSDT">BTC</button>
        <button class="btn" data-preset="BYBIT:ETHUSDT">ETH</button>
        <button class="btn" data-preset="BYBIT:SOLUSDT">SOL</button>
        <button class="btn" data-preset="BYBIT:XRPUSDT">XRP</button>
        <button class="btn" data-preset="BYBIT:DOGEUSDT">DOGE</button>
      </div>
      <div class="flex" style="flex-wrap:wrap;gap:8px;margin-bottom:6px;align-items:center">
        <span class="badge">âš« OKX</span>
        <button class="btn" data-preset="OKX:BTCUSDT.P">BTC</button>
        <button class="btn" data-preset="OKX:ETHUSDT.P">ETH</button>
        <button class="btn" data-preset="OKX:SOLUSDT.P">SOL</button>
        <button class="btn" data-preset="OKX:AVAXUSDT.P">AVAX</button>
        <button class="btn" data-preset="OKX:DOTUSDT.P">DOT</button>
      </div>
      <div class="flex" style="flex-wrap:wrap;gap:8px;margin-bottom:6px;align-items:center">
        <span class="badge">ğŸ”µ Pionex</span>
        <button class="btn" data-preset="PIONEX:BTCUSDT.P">BTC</button>
        <button class="btn" data-preset="PIONEX:ETHUSDT.P">ETH</button>
        <button class="btn" data-preset="PIONEX:SOLUSDT.P">SOL</button>
        <button class="btn" data-preset="PIONEX:BNBUSDT.P">BNB</button>
		        <button class="btn" data-preset="PIONEX:XRPUSDT.P">XRP</button>
      </div>
      <div class="flex" style="flex-wrap:wrap;gap:8px;align-items:center">
        <span class="badge">ğŸ”´ BingX</span>
        <button class="btn" data-preset="BINGX:BTCUSDT.P">BTC</button>
        <button class="btn" data-preset="BINGX:ETHUSDT.P">ETH</button>
        <button class="btn" data-preset="BINGX:SOLUSDT.P">SOL</button>
        <button class="btn" data-preset="BINGX:LINKUSDT.P">LINK</button>
        <button class="btn" data-preset="BINGX:UNIUSDT.P">UNI</button>
      </div>
    </div>

    <div class="row">
      <div class="col" style="grid-column:span 3">
        <label>äº¤æ˜“æ‰€</label>
        <select class="input" id="tv-ex">
          <option>BINANCE</option><option>BYBIT</option><option>PIONEX</option><option>BINGX</option><option>OKX</option>
        </select>
      </div>
      <div class="col" style="grid-column:span 5">
        <label>ä¸»åœ–ä»£ç¢¼ï¼ˆEXCHANGE:SYMBOLï¼‰</label>
        <input class="input" id="tv-symbol" value="BINANCE:BTCUSDT" />
      </div>
      <div class="col" style="grid-column:span 2">
        <label>æ™‚æ¡†</label>
        <select class="input" id="tv-interval">
          <option value="15">15m</option><option value="30">30m</option><option value="60" selected>1h</option><option value="240">4h</option><option value="D">1D</option>
        </select>
      </div>
      <div class="col right" style="grid-column:span 2">
        <label>&nbsp;</label>
        <button class="btn primary" id="tv-apply">å¥—ç”¨</button>
      </div>
    </div>

    <!-- è§€å¯Ÿæ¸…å–® -->
    <div class="row" style="margin-top:8px">
      <div style="grid-column:span 10">
        <label>è§€å¯Ÿæ¸…å–®ï¼ˆç©ºç™½åˆ†éš”ï¼›ä¾‹å¦‚ï¼šBINANCE:BTCUSDT BYBIT:BTCUSDT BINGX:BTCUSDTï¼‰</label>
        <input id="watchlist" class="input" placeholder="BINANCE:BTCUSDT BYBIT:BTCUSDT BINGX:BTCUSDT OKX:BTC-USDT-SWAP" />
        <div class="pills" id="watch-pills"></div>
        <small class="note">é»è† å›Šæ¨™ç±¤å³å¯å¿«é€Ÿåˆ‡æ›åœ–è¡¨ã€‚</small>
      </div>
      <div class="right" style="grid-column:span 2;align-self:end">
        <button class="btn" id="btn-apply-watch">ç”Ÿæˆæ¨™ç±¤</button>
      </div>
    </div>

    <small>æç¤ºï¼šæ”¹ä»£ç¢¼å¾ŒæŒ‰ã€Œå¥—ç”¨ã€ã€‚åˆ‡æ›æ·±/æ·ºè‰²æ™‚ï¼Œåœ–è¡¨å°‡è‡ªå‹•é‡å»ºä¸”ä¿ç•™ç•«åœ–å·¥å…·ã€‚</small>
    <div class="hr"></div>
    <div id="tv-container" style="height:560px"></div>
  </section>

  <!-- æ¨¡æ“¬è©¦ç®— -->
  <section id="p-sim" class="card" style="display:none">
    <h3>æ¨¡æ“¬äº¤æ˜“è©¦ç®—</h3>
    <div class="row">
      <div style="grid-column:span 3"><label>å¹£ç¨®ï¼ˆå°‡ä¸€éµå¸¶å…¥ç´€éŒ„ï¼‰</label><input class="input" id="sim-asset" value="BTCUSDT"/></div>
      <div style="grid-column:span 3"><label>æ–¹å‘</label><select class="input" id="sim-side"><option>å¤š</option><option>ç©º</option></select></div>
      <div style="grid-column:span 3"><label>æœ¬é‡‘ï¼ˆUSDTï¼‰</label><input class="input" id="sim-capital" type="number" value="100"/></div>
      <div style="grid-column:span 3"><label>æ§“æ¡¿ï¼ˆÃ—ï¼‰</label><input class="input" id="sim-lev" type="number" value="10"/></div>
      <div style="grid-column:span 3"><label>é€²å ´åƒ¹</label><input class="input" id="sim-entry" type="number" value="200"/></div>
      <div style="grid-column:span 3"><label>TPï¼ˆæ­¢ç›ˆåƒ¹ï¼‰</label><input class="input" id="sim-tp" type="number" value="220"/></div>
      <div style="grid-column:span 3"><label>SLï¼ˆåœæåƒ¹ï¼‰</label><input class="input" id="sim-sl" type="number" value="189"/></div>
      <div style="grid-column:span 3"><label>æ‰‹çºŒè²»ï¼ˆUSDTï¼Œå¯ç©ºç™½ï¼‰</label><input class="input" id="sim-fee" type="number" value="0"/></div>
      <div style="grid-column:span 3"><label>æ¯ç­†é¢¨éšª %ï¼ˆä¾†è‡ªè³‡é‡‘ç®¡ç†ï¼‰</label><input class="input" id="sim-risk" type="number" value="1"/></div>
      <div class="right" style="grid-column:span 6;align-self:end"><button class="btn primary" id="btn-recalc">é‡æ–°è¨ˆç®—</button></div>
      <div class="right" style="grid-column:span 3;align-self:end"><button class="btn" id="btn-to-record">ä¸€éµå¸¶åˆ°ã€Œå¯¦éš›äº¤æ˜“ç´€éŒ„ã€</button></div>
    </div>
    <div class="grid" style="grid-template-columns:1fr 1fr 1fr;margin-top:12px">
      <div class="card"><div class="flex"><span class="badge">åç¾©éƒ¨ä½ï¼ˆæœ¬é‡‘Ã—æ§“æ¡¿ï¼‰</span></div><div class="kpi" id="kpi-notional">2000.00 USDT</div><div class="hr"></div><div><span class="badge">ä¿è­‰é‡‘ï¼ˆä¼°ï¼‰</span> <span id="kpi-margin" style="font-weight:700">100.00 USDT</span></div></div>
      <div class="card"><div class="flex"><span class="badge">TP æç›Š</span></div><div class="kpi" id="kpi-tp">+20.00 USDT</div><div class="hr"></div><div class="flex"><span class="badge">SL æç›Š</span><span id="kpi-sl" style="font-weight:700">-11.00 USDT</span></div></div>
      <div class="card"><div class="flex"><span class="badge">R:Rï¼ˆå ±é…¬/é¢¨éšªï¼‰</span></div><div class="kpi" id="kpi-rrr">1.82</div><div class="hr"></div><div><span class="badge">å»ºè­°æŠ•å…¥ï¼ˆä¾ SL è¨ˆï¼‰</span> <span id="kpi-size" style="font-weight:700">181.82 USDT</span></div></div>
    </div>
    <small>å…¬å¼ï¼šæœ€å¤§é¢¨éšªé‡‘é¡ï¼æœ¬é‡‘Ã—é¢¨éšª%ï¼›å»ºè­°æŠ•å…¥ï¼è©²é‡‘é¡ Ã· |é€²å ´âˆ’SL| Ã— é€²å ´ï¼›R:Rï¼|TPæç›Š| Ã· |SLæç›Š|ã€‚</small>
  </section>

  <!-- å¯¦éš›äº¤æ˜“ç´€éŒ„ -->
  <section id="p-records" class="card" style="display:none">
    <h3>å¯¦éš›äº¤æ˜“ç´€éŒ„</h3>
    <div class="row">
      <div style="grid-column:span 3"><label>å¹£ç¨®ï¼ˆå¦‚ BTCUSDTï¼‰</label><input id="rec-asset" class="input" value="BTCUSDT"/></div>
      <div style="grid-column:span 3"><label>æŠ•è³‡é¡ï¼ˆUSDTï¼‰</label><input id="rec-invest" type="number" class="input" value="100"/></div>
      <div style="grid-column:span 2"><label>æ§“æ¡¿ï¼ˆÃ—ï¼‰</label><input id="rec-lev" type="number" class="input" value="10"/></div>
      <div style="grid-column:span 2"><label>æ–¹å‘</label><select id="rec-side" class="input"><option>å¤š</option><option>ç©º</option></select></div>
      <div style="grid-column:span 2"><label>é–‹å€‰åƒ¹</label><input id="rec-open" type="number" class="input" value="220"/></div>
      <div style="grid-column:span 2"><label>TP</label><input id="rec-tp" type="number" class="input" value="260"/></div>
      <div style="grid-column:span 2"><label>SL</label><input id="rec-sl" type="number" class="input" value="189"/></div>
      <div style="grid-column:span 2"><label>RRRï¼ˆè‡ªå‹•ï¼‰</label><input id="rec-rrr" class="input" value="â€”" readonly/></div>
      <div style="grid-column:span 3"><label>æ‰‹çºŒè²»ï¼ˆUSDTï¼Œå¯ç©ºç™½ï¼‰</label><input id="rec-fee" type="number" class="input" value="0"/></div>
      <div style="grid-column:span 3"><label>æ˜¯å¦å·²å¹³å€‰</label><select id="rec-closed" class="input"><option>å¦</option><option>å·²å¹³å€‰</option></select></div>
      <div style="grid-column:span 3"><label>å¹³å€‰åƒ¹ï¼ˆè‹¥å·²å¹³å€‰ï¼‰</label><input id="rec-close" type="number" class="input" value="0"/></div>
      <div style="grid-column:span 3"><label>å¯¦éš›ç›ˆè™§ï¼ˆUSDTï¼Œå¯ç©ºç™½ï¼‰</label><input id="rec-pl" type="number" class="input" value="0"/></div>
      <div style="grid-column:span 12"><label>é€²å ´ç†ç”±</label><input id="rec-reason" class="input" placeholder="è¶¨å‹¢å»¶çºŒã€çªç ´å›æ¸¬â€¦"/></div>
    </div>
    <div class="flex right" style="margin-top:8px">
      <button class="btn primary" id="btn-add-record">æ–°å¢</button>
      <button class="btn" id="btn-clear-records">å…¨éƒ¨æ¸…ç©ºï¼ˆæœ¬æ©Ÿï¼‰</button>
    </div>
    <small>æç¤ºï¼šé»ã€Œä¿®æ”¹ã€æœƒæŠŠè©²ç­†å¸¶å›ä¸Šæ–¹è¡¨å–®ï¼Œæ”¹å®ŒæŒ‰ã€Œæ–°å¢ã€å³è¦†å¯«ï¼›è³‡æ–™æœƒè‡ªå‹•åŒæ­¥åˆ° Supabaseã€‚</small>
    <div class="hr"></div>
    <table class="tbl" id="tbl-records"><thead>
      <tr><th>#</th><th>æ™‚é–“</th><th>å¹£ç¨®</th><th>æ–¹å‘</th><th>é–‹å€‰</th><th>æœ¬é‡‘</th><th>æ§“æ¡¿</th><th>ä¿è­‰é‡‘</th><th>TP</th><th>SL</th><th>RRR</th><th>å·²å¹³å€‰</th><th>å¹³å€‰åƒ¹</th><th>ç›ˆè™§</th><th>æ‰‹çºŒè²»</th><th>ç†ç”±</th><th>æ“ä½œ</th></tr>
    </thead><tbody></tbody></table>
  </section>

  <!-- é‡åŒ–æ±ºç­– -->
  <section id="p-quant" class="card" style="display:none">
    <h3>é‡åŒ–æ±ºç­–è¡¨ï¼ˆäººå·¥é‡åŒ–æ ¸å¿ƒï¼‰</h3>
    <small>æ­¤ä»‹é¢ç”¨æ–¼é‡åŒ–è©•ä¼°äº¤æ˜“æ©Ÿæœƒï¼Œæ’é™¤äººç‚ºæƒ…ç·’å¹²æ“¾ï¼Œä¸¦å¯ä½œç‚ºå›æ¸¬çµ±è¨ˆä¾æ“šã€‚</small>
    <div class="card" style="margin-bottom:12px">
      <h3>é‡åŒ–æ±ºç­–å„€è¡¨æ¿</h3>
      <div class="card" style="margin-bottom:12px;background:var(--chip)">
        <h4>å…±æŒ¯æ¢ä»¶åˆ†æ</h4>
        <p><small>å‹¾é¸æ‚¨æƒ³çµ„åˆçš„æ¢ä»¶ï¼Œç„¶å¾Œé»æ“Šã€Œåˆ†æã€æŒ‰éˆ•ã€‚å„€è¡¨æ¿å°‡åªçµ±è¨ˆ **åŒæ™‚æ»¿è¶³æ‰€æœ‰å‹¾é¸æ¢ä»¶** çš„äº¤æ˜“æ±ºç­–å‹ç‡ã€‚</small></p>
        <div id="resonance-filters" class="pills" style="margin-bottom:12px;flex-wrap:wrap;gap:10px;">
          <!-- Filter checkboxes will be rendered here by JS -->
        </div>
        <div class="flex">
          <button class="btn primary" id="btn-analyze-resonance">åˆ†æå…±æŒ¯å‹ç‡</button>
          <div id="resonance-result" style="margin-left:16px;font-weight:bold;"></div>
        </div>
      </div>
      <h4>å–®ä¸€æ¢ä»¶å‹ç‡</h4>
      <div class="grid" id="quant-dashboard-individual" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px">
        <!-- Individual KPI cards will be rendered here -->
      </div>
      <small style="display:block;margin-top:8px">çµ±è¨ˆæ•¸æ“šåŸºæ–¼ã€Œçµæœã€éã€ŒæœªåŸ·è¡Œã€çš„æ±ºç­–ç´€éŒ„ã€‚</small>
    </div>
    <div class="row" style="margin-top:8px">
      <div style="grid-column:span 3"><label>æ¨™çš„</label><input id="qt-asset" class="input" placeholder="å¦‚ SOL"/></div>
		      <div style="grid-column:span 3"><label><input type="checkbox" id="qt-chk-pattern" checked> ç†Ÿæ‚‰çš„å½¢æ…‹</label><select id="qt-pattern" class="input">
        <option value="é ­è‚©é ‚">é ­è‚©é ‚</option>
        <option value="é ­è‚©åº•">é ­è‚©åº•</option>
        <option value="é€šé“">é€šé“</option>
        <option value="vegas">vegas</option>
        <option value="å…¶ä»–" selected>å…¶ä»–</option>
      </select></div>
		      <div style="grid-column:span 3"><label><input type="checkbox" id="qt-chk-trend" checked> è¶¨å‹¢</label><select id="qt-trend" class="input">
        <option value="ä¸Šè¡Œè¶¨å‹¢" selected>ä¸Šè¡Œè¶¨å‹¢</option>
        <option value="ä¸‹è¡Œè¶¨å‹¢">ä¸‹è¡Œè¶¨å‹¢</option>
        <option value="ç›¤æ•´å€é–“">ç›¤æ•´å€é–“</option>
      </select></div>
		      <div style="grid-column:span 3"><label><input type="checkbox" id="qt-chk-market" checked> æ˜¯å¦è·Ÿéš¨å¤§ç›¤èµ°å‹¢</label><select id="qt-market" class="input">
        <option value="æ˜¯" selected>æ˜¯</option>
        <option value="å¦">å¦</option>
      </select></div>
      <div style="grid-column:span 3"><label>RRR é¢¨å ±æ¯” (è‡³å°‘)</label><input id="qt-rrr" class="input" type="number" value="3"/></div>
		      <div style="grid-column:span 3"><label><input type="checkbox" id="qt-chk-draw" checked> æ”¯æ’é˜»åŠ›å€èˆ‡fiboæ˜¯å¦ç•«å¥½</label><select id="qt-draw" class="input">
        <option value="æ˜¯TP SLå·²è¨­å®š" selected>æ˜¯TP SLå·²è¨­å®š</option>
        <option value="å¦">å¦</option>
      </select></div>
		      <div style="grid-column:span 3"><label><input type="checkbox" id="qt-chk-breakout" checked> çªç ´äº¤æ˜“</label><select id="qt-breakout" class="input">
        <option value="çªç ´æ¿€é€²é€²å ´" selected>çªç ´æ¿€é€²é€²å ´</option>
        <option value="çªç ´å›è¸©é€²å ´">çªç ´å›è¸©é€²å ´</option>
      </select></div>
      <div style="grid-column:span 3"><label>æ˜¯å¦é€²å ´</label><select id="qt-enter" class="input">
        <option value="æ˜¯" selected>æ˜¯</option>
        <option value="å¦">å¦</option>
      </select></div>
		      <div style="grid-column:span 3"><label><input type="checkbox" id="qt-chk-kline" checked> K ç·šå‹æ…‹</label><select id="qt-kline" class="input"><option value="å¸¶é•·ä¸Šå½±ç·š">å¸¶é•·ä¸Šå½±ç·š</option><option value="å¸¶é•·ä¸‹å½±ç·š">å¸¶é•·ä¸‹å½±ç·š</option><option value="æ”¾é‡Kæ£’">æ”¾é‡ K æ£’</option><option value="åå™¬/åˆºé€">åå™¬/åˆºé€</option></select></div>	      <div style="grid-column:span 6"><label>å‚™è¨»</label><input id="qt-note" class="input" placeholder="å›æ¸¬æœ‰æ’ / é—œéµä½çªç ´â€¦"/></div>
    </div>
    <div class="flex right" style="margin-top:8px">
      <button class="btn primary" id="btn-add-decision">åŠ å…¥æ±ºç­–è¡¨</button>
      <button class="btn" id="btn-csv">åŒ¯å‡º CSV</button>
    </div>
    <div class="hr"></div>
    <table class="tbl" id="tbl-quant"><thead>
		      <tr><th>#</th><th>æ¨™çš„</th><th>å½¢æ…‹</th><th>è¶¨å‹¢</th><th>å¤§ç›¤</th><th>Kç·š</th><th>RRR</th><th>çªç ´</th><th>ç•«ç·š</th><th>æ˜¯å¦é€²å ´</th><th>çµæœ</th><th>å‚™è¨»</th><th>æ“ä½œ</th></tr>
    </thead><tbody></tbody></table>
  </section>

  <!-- è¨­å®šï¼ˆé›²ç«¯ï¼‰ -->
  <section id="p-cloud" class="card" style="display:none">
    <h3>é›²ç«¯æ¨¡å¼ï¼ˆSupabaseï¼Œè‡ªå‹•ä¸Šå‚³ï¼‰</h3>
    <small>å¡«å…¥ <b>Project URL</b> èˆ‡ <b>Anon Key</b> å¾ŒæŒ‰ã€Œå„²å­˜ä¸¦é€£ç·šã€ã€‚ä¹‹å¾Œæ–°å¢/ä¿®æ”¹/åˆªé™¤ç´€éŒ„èˆ‡æ±ºç­–ï¼Œæœƒè‡ªå‹•åŒæ­¥åˆ°é›²ç«¯ã€‚</small>
    <div class="row" style="margin-top:8px">
      <div style="grid-column:span 8"><label>Project URLï¼ˆå« https://ï¼‰</label><input id="sb-url" class="input" placeholder="https://xxxxx.supabase.co"/></div>
      <div style="grid-column:span 12"><label>Anon Public Key</label><textarea id="sb-key" rows="3" class="input" placeholder="eyJhbGciOi..."></textarea></div>
    </div>
    <div class="flex right" style="margin-top:8px">
      <button class="btn" id="btn-save-cloud">å„²å­˜ä¸¦é€£ç·šï¼ˆæ”¹ç”¨é›²ç«¯ï¼‰</button>
      <button class="btn danger" id="btn-clear-cloud">æ¸…é™¤è¨­å®šï¼ˆæ”¹ç”¨é›¢ç·šï¼‰</button>
    </div>
    <div class="hr"></div>
    <h4>è¨­å®šæ­¥é©Ÿ</h4>
    <small>
      <p><b>1. ç™»å…¥ Supabase</b> - å‰å¾€ <a href="https://supabase.com" target="_blank">supabase.com</a></p>
      <p><b>2. å»ºç«‹æ–°å°ˆæ¡ˆ</b> - æˆ–ä½¿ç”¨ç¾æœ‰å°ˆæ¡ˆ</p>
      <p><b>3. è¤‡è£½ Project URL</b> - åœ¨ Settings â†’ API ä¸­æ‰¾åˆ°</p>
      <p><b>4. è¤‡è£½ Anon Key</b> - åœ¨ Settings â†’ API ä¸­æ‰¾åˆ°</p>
      <p><b>5. è²¼åˆ°ä¸Šæ–¹æ¬„ä½</b> - ç„¶å¾Œé»ã€Œå„²å­˜ä¸¦é€£ç·šã€</p>
      <p><b>6. å»ºç«‹è³‡æ–™è¡¨</b> - é¦–æ¬¡é€£ç·šæ™‚ï¼Œç³»çµ±æœƒæç¤ºæ‚¨éœ€è¦åŸ·è¡Œ SQLï¼Œè¤‡è£½ SQL åˆ° Supabase SQL Editor åŸ·è¡Œå³å¯</p>
    </small>
    <div class="hr"></div>
    <small class="note" id="cloud-status">æœªé€£ç·š - è³‡æ–™å­˜å„²åœ¨æœ¬æ©Ÿ</small>
  </section>
</div>

<div id="toast" class="toast hide"></div>

<script>
/* ==================== Supabase åˆå§‹åŒ– ==================== */
let supabase = null;
let isCloudEnabled = false;

async function initSupabase(url, key) {
  try {
    const { createClient } = window.supabase;
    supabase = createClient(url, key);
    
    // æ¸¬è©¦é€£ç·š
    const { data, error } = await supabase.from('utr_records').select('count', { count: 'exact', head: true });
    
    if (error && error.code === 'PGRST116') {
      // è³‡æ–™è¡¨ä¸å­˜åœ¨ï¼Œéœ€è¦å»ºç«‹
      showCreateTableSQL();
      return false;
    }
    
    isCloudEnabled = true;
    updateCloudStatus('å·²é€£ç·š âœ“');
    toast('âœ… Supabase é€£ç·šæˆåŠŸï¼');
    await pullFromCloud();
    return true;
  } catch (err) {
    console.error('Supabase åˆå§‹åŒ–å¤±æ•—:', err);
    updateCloudStatus('é€£ç·šå¤±æ•—: ' + err.message);
    toast('âŒ é€£ç·šå¤±æ•—: ' + err.message, 3000);
    return false;
  }
}

function showCreateTableSQL() {
  const sql = `-- åœ¨ Supabase SQL Editor åŸ·è¡Œæ­¤ SQLï¼š
create table if not exists utr_records (
  id text primary key,
  time text,
  asset text,
  invest numeric,
  lev numeric,
  side text,
  open numeric,
  tp numeric,
  sl numeric,
  rrr numeric,
  closed text,
  close numeric,
  pl numeric,
  fee numeric,
  reason text,
  created_at timestamp default now()
);

create table if not exists utr_decisions (
  id text primary key,
  asset text,
  pattern text,
  trend text,
  market text,
  breakout text,
  draw text,
  rrr numeric,
  enter text,
  result text,
  kline text,
  note text,
  created_at timestamp default now()
);`;
  
  alert('é¦–æ¬¡ä½¿ç”¨éœ€è¦å»ºç«‹è³‡æ–™è¡¨ã€‚\n\nè«‹è¤‡è£½ä¸‹æ–¹ SQL åˆ° Supabase SQL Editor åŸ·è¡Œï¼š\n\n' + sql);
}

async function cloudSync(kind) {
  if (!isCloudEnabled || !supabase) return;
  
  try {
    updateCloudStatus('åŒæ­¥ä¸­...');
    
    if (kind === 'records' || !kind) {
      const records = appState.records;
      for (const record of records) {
        await supabase.from('utr_records').upsert(record, { onConflict: 'id' });
      }
    }
    
    if (kind === 'decisions' || !kind) {
      const decisions = appState.decisions;
      for (const decision of decisions) {
        await supabase.from('utr_decisions').upsert(decision, { onConflict: 'id' });
      }
    }
    
    updateCloudStatus('å·²åŒæ­¥ âœ“');
    setTimeout(() => updateCloudStatus('å·²é€£ç·š âœ“'), 2000);
  } catch (err) {
    console.error('åŒæ­¥å¤±æ•—:', err);
    updateCloudStatus('åŒæ­¥å¤±æ•— âŒ');
  }
}

async function pullFromCloud() {
  if (!isCloudEnabled || !supabase) return;
  
  try {
    const { data: records } = await supabase.from('utr_records').select('*');
    const { data: decisions } = await supabase.from('utr_decisions').select('*');
    
    if (records) {
      appState.records = records;
      persist('ut_records', records);
    }
    if (decisions) {
      appState.decisions = decisions;
      persist('ut_decisions', decisions);
    }
    
    renderRecords();
    renderQuant();
    updateDashboard();
  } catch (err) {
    console.error('æ‹‰å–è³‡æ–™å¤±æ•—:', err);
  }
}

function updateCloudStatus(status) {
  document.getElementById('cloud-status').textContent = status;
  document.getElementById('sync-status').textContent = status;
  document.getElementById('sync-status').className = 'sync-badge ' + 
    (status.includes('âœ“') ? 'synced' : status.includes('ä¸­') ? 'syncing' : 'error');
}

/* ==================== å·¥å…·å‡½æ•¸ ==================== */
function toast(msg, ms=3600){const t=document.getElementById('toast');t.innerHTML=msg;t.classList.remove('hide');setTimeout(()=>t.classList.add('hide'),ms)}
function fmt(n){ return (isFinite(n)?Number(n).toFixed(2):'â€”'); }
function persist(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function get(k,def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def; }catch(e){ return def; } }

/* ==================== App ç‹€æ…‹ ==================== */
const appState = {
  theme: localStorage.getItem('ut_theme') || 'light',
  records: get('ut_records', []),
  decisions: get('ut_decisions', []),
  cloud: get('ut_cloud', {}),
  watch: get('ut_watch', "BINANCE:BTCUSDT BYBIT:BTCUSDT BINGX:BTCUSDT OKX:BTC-USDT-SWAP")
};
document.documentElement.setAttribute('data-theme', appState.theme);

// å¦‚æœå·²ä¿å­˜é›²ç«¯è¨­å®šï¼Œè‡ªå‹•é€£ç·š
if (appState.cloud.url && appState.cloud.key) {
  document.getElementById('sb-url').value = appState.cloud.url;
  document.getElementById('sb-key').value = appState.cloud.key;
  initSupabase(appState.cloud.url, appState.cloud.key);
}

/* ==================== Tabs ==================== */
document.querySelectorAll('#tabs .tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('#tabs .tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const page=btn.dataset.page;
    document.querySelectorAll('section[id^="p-"]').forEach(s=>s.style.display='none');
    document.getElementById(page).style.display='';
    if(page==='p-market'){ renderTV(true); }
  });
});

/* ==================== Theme ==================== */
document.getElementById('lightBtn').onclick=()=>setTheme('light');
document.getElementById('darkBtn').onclick=()=>setTheme('dark');
function setTheme(t){
  appState.theme=t; localStorage.setItem('ut_theme',t);
  document.documentElement.setAttribute('data-theme', t);
  if(document.getElementById('p-market').style.display!=='none'){ renderTV(true); }
}
(function(){ (appState.theme==='dark'?darkBtn:lightBtn).classList.add('primary'); })();

/* ==================== TradingView ==================== */
let tvWidget=null;
function buildWatchPills(){
  const wrap=document.getElementById('watch-pills'); wrap.innerHTML='';
  const list=(document.getElementById('watchlist').value||'').trim().split(/\s+/).filter(Boolean);
  list.forEach((s,idx)=>{
    const p=document.createElement('span'); p.className='pill'+(idx===0?' active':''); p.textContent=s;
    p.onclick=()=>{ wrap.querySelectorAll('.pill').forEach(x=>x.classList.remove('active')); p.classList.add('active'); setSymbol(s); };
    wrap.appendChild(p);
  });
  persist('ut_watch', document.getElementById('watchlist').value);
}
function setSymbol(sym){
  document.getElementById('tv-symbol').value = sym;
  if(tvWidget){ tvWidget.remove(); tvWidget=null; }
  renderTV(true);
}
function renderTV(force){
  const sym = (document.getElementById('tv-symbol').value||'BINANCE:BTCUSDT').trim();
  const interval = document.getElementById('tv-interval').value;
  const theme = (appState.theme==='dark') ? 'dark' : 'light';
  if(force && tvWidget){ tvWidget.remove(); tvWidget=null; }
  if(tvWidget){ return; }
  tvWidget = new TradingView.widget({
    autosize:true,
    symbol:sym,
    interval:interval,
    container_id:"tv-container",
    theme:theme,
    timezone:"Asia/Taipei",
    style:"1",
    locale:"zh_TW",
    hide_top_toolbar:false,
    hide_side_toolbar:false,
    allow_symbol_change:true,
    details:true,
    calendar:false,
  });
}
document.getElementById('tv-apply').onclick=()=>{ if(tvWidget){ tvWidget.remove(); tvWidget=null;} renderTV(true); };
document.getElementById('btn-apply-watch').onclick=()=>buildWatchPills();
document.querySelectorAll('button[data-preset]').forEach(b=>{
  b.onclick=()=>{ setSymbol(b.dataset.preset); }
});
document.getElementById('watchlist').value = appState.watch; buildWatchPills(); renderTV();

/* ==================== æ¨¡æ“¬è©¦ç®— ==================== */
function calcSim(){
  const side=document.getElementById('sim-side').value;
  const capital=+document.getElementById('sim-capital').value||0;
  const lev=+document.getElementById('sim-lev').value||1;
  const entry=+document.getElementById('sim-entry').value||0;
  const tp=+document.getElementById('sim-tp').value||0;
  const sl=+document.getElementById('sim-sl').value||0;
  const fee=+document.getElementById('sim-fee').value||0;
  const riskPct=(+document.getElementById('sim-risk').value||1)/100;

  const notional=capital*lev;
  const margin=capital;
  const dir=(side==='å¤š')?1:-1;
  const qty = (entry>0)? (capital*lev/entry) : 0;
  const tpProfit = ((tp-entry)*dir)*qty - fee;
  const slProfit = ((sl-entry)*dir)*qty - fee;
  const rrr=(Math.abs(slProfit)>0)? Math.abs(tpProfit)/Math.abs(slProfit):0;
  const riskAmt=capital*riskPct;
  const suggestNotional=(Math.abs(entry-sl)>0)? (riskAmt/Math.abs(entry-sl))*entry : 0;
  const suggestMargin=suggestNotional/lev;

  document.getElementById('kpi-notional').textContent=fmt(notional)+' USDT';
  document.getElementById('kpi-margin').textContent=fmt(margin)+' USDT';
  const kti=document.getElementById('kpi-tp'); kti.textContent=(tpProfit>=0?'+':'')+fmt(tpProfit)+' USDT'; kti.style.color=tpProfit>=0?'var(--accent)':'var(--danger)';
  const ksi=document.getElementById('kpi-sl'); ksi.textContent=(slProfit>=0?'+':'')+fmt(slProfit)+' USDT'; ksi.style.color=slProfit>=0?'var(--accent)':'var(--danger)';
  document.getElementById('kpi-rrr').textContent= rrr? rrr.toFixed(2):'â€”';
  document.getElementById('kpi-size').textContent=fmt(suggestMargin)+' USDT';
}
document.getElementById('btn-recalc').onclick=calcSim; calcSim();
document.getElementById('btn-to-record').onclick=()=>{
  document.querySelector('[data-page="p-records"]').click();
  document.getElementById('rec-asset').value=document.getElementById('sim-asset').value;
  document.getElementById('rec-side').value=document.getElementById('sim-side').value;
  document.getElementById('rec-invest').value=document.getElementById('sim-capital').value;
  document.getElementById('rec-lev').value=document.getElementById('sim-lev').value;
  document.getElementById('rec-open').value=document.getElementById('sim-entry').value;
  document.getElementById('rec-tp').value=document.getElementById('sim-tp').value;
  document.getElementById('rec-sl').value=document.getElementById('sim-sl').value;
};

/* ==================== ç´€éŒ„è¡¨ ==================== */
function recalcRRR(open,tp,sl,side,inv,lev){
  const dir=(side==='å¤š')?1:-1, qty=(open>0)? inv*lev/open:0;
  const tpProfit=(tp-open)*dir*qty, slProfit=(sl-open)*dir*qty;
  return (Math.abs(slProfit)>0)? Math.abs(tpProfit)/Math.abs(slProfit) : 0;
}

function updateDashboard(){
  const closed = appState.records.filter(r=>r.closed==='å·²å¹³å€‰');
  const total = closed.length;
  const totalPL = closed.reduce((sum,r)=>sum+(parseFloat(r.pl)||0),0);
  const wins = closed.filter(r=>(parseFloat(r.pl)||0)>0);
  const winrate = total>0 ? (wins.length/total*100).toFixed(1) : 0;
  const avgRRR = closed.length>0 ? (closed.reduce((sum,r)=>sum+(parseFloat(r.rrr)||0),0)/closed.length).toFixed(2) : '0.00';
  const maxWin = closed.length>0 ? Math.max(...closed.map(r=>parseFloat(r.pl)||0)).toFixed(2) : '0.00';
  const maxLoss = closed.length>0 ? Math.min(...closed.map(r=>parseFloat(r.pl)||0)).toFixed(2) : '0.00';
  
  document.getElementById('dash-total').textContent = total;
  document.getElementById('dash-pl').textContent = totalPL.toFixed(2);
  document.getElementById('dash-pl').style.color = totalPL>=0 ? 'var(--accent)' : 'var(--danger)';
  document.getElementById('dash-winrate').textContent = winrate + '%';
  document.getElementById('dash-rrr').textContent = avgRRR;
  document.getElementById('dash-maxwin').textContent = '+' + maxWin;
  document.getElementById('dash-maxloss').textContent = maxLoss;
}

function renderRecords(){
  const tbody=document.querySelector('#tbl-records tbody'); tbody.innerHTML='';
  appState.records.forEach((r,i)=>{
    const plColor = (parseFloat(r.pl)||0) >= 0 ? 'var(--accent)' : 'var(--danger)';
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${i+1}</td><td>${r.time}</td><td>${r.asset}</td><td>${r.side}</td>
      <td>${r.open}</td><td>${r.invest}</td><td>${r.lev}</td><td>${(r.invest).toFixed(2)}</td>
      <td>${r.tp}</td><td>${r.sl}</td><td>${r.rrr? r.rrr.toFixed(2):'â€”'}</td>
      <td>${r.closed}</td><td>${r.close||'-'}</td><td style="color:${plColor}">${r.pl||'-'}</td><td>${r.fee||0}</td>
      <td>${r.reason||''}</td>
      <td class="flex"><button class="btn" data-edit="${i}">ä¿®æ”¹</button><button class="btn danger" data-del="${i}">åˆªé™¤</button></td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('[data-edit]').forEach(b=>{
    b.onclick=()=>{
      const r=appState.records[+b.dataset.edit];
      document.getElementById('rec-asset').value=r.asset; document.getElementById('rec-invest').value=r.invest; document.getElementById('rec-lev').value=r.lev; document.getElementById('rec-side').value=r.side;
      document.getElementById('rec-open').value=r.open; document.getElementById('rec-tp').value=r.tp; document.getElementById('rec-sl').value=r.sl; updateRecRRR();
      document.getElementById('rec-closed').value=r.closed; document.getElementById('rec-close').value=r.close||0; document.getElementById('rec-pl').value=r.pl||0; document.getElementById('rec-fee').value=r.fee||0; document.getElementById('rec-reason').value=r.reason||'';
      document.getElementById('btn-add-record').dataset.editIndex=b.dataset.edit;
    };
  });
  tbody.querySelectorAll('[data-del]').forEach(b=>{
    b.onclick=()=>{ appState.records.splice(+b.dataset.del,1); persist('ut_records',appState.records); renderRecords(); cloudSync('records'); updateDashboard(); };
  });
  updateDashboard();
}
function updateRecRRR(){
  const side=document.getElementById('rec-side').value;
  const invest=+document.getElementById('rec-invest').value||0, lev=+document.getElementById('rec-lev').value||1;
  const open=+document.getElementById('rec-open').value||0, tp=+document.getElementById('rec-tp').value||0, sl=+document.getElementById('rec-sl').value||0;
  const rrr=recalcRRR(open,tp,sl,side,invest,lev);
  document.getElementById('rec-rrr').value=rrr? rrr.toFixed(2):'â€”';
}
document.querySelectorAll('#rec-invest, #rec-lev, #rec-side, #rec-open, #rec-tp, #rec-sl').forEach(el=>el.addEventListener('input', updateRecRRR));
updateRecRRR();

document.getElementById('btn-add-record').onclick=()=>{
  const asset=document.getElementById('rec-asset').value.trim().toUpperCase();
  const invest=+document.getElementById('rec-invest').value||0, lev=+document.getElementById('rec-lev').value||1, side=document.getElementById('rec-side').value;
  const open=+document.getElementById('rec-open').value||0, tp=+document.getElementById('rec-tp').value||0, sl=+document.getElementById('rec-sl').value||0;
  const fee=+document.getElementById('rec-fee').value||0, closed=document.getElementById('rec-closed').value, close=+document.getElementById('rec-close').value||0, pl=+document.getElementById('rec-pl').value||0;
  const reason=document.getElementById('rec-reason').value||'';
  const rrr=+document.getElementById('rec-rrr').value||0;
  const item={ id:(Date.now().toString(36)+Math.random().toString(36).slice(2)), 
    time:new Date().toLocaleString(), asset, invest, lev, side, open, tp, sl, rrr, closed, close, pl, fee, reason };
  const idx=document.getElementById('btn-add-record').dataset.editIndex;
  if(idx!==undefined){ item.id=appState.records[+idx].id; appState.records[+idx]=item; delete document.getElementById('btn-add-record').dataset.editIndex; }
  else{ appState.records.unshift(item); }
  persist('ut_records',appState.records); renderRecords(); cloudSync('records');
};
document.getElementById('btn-clear-records').onclick=()=>{
  if(confirm('ç¢ºå®šæ¸…ç©ºæœ¬æ©Ÿæ‰€æœ‰ç´€éŒ„ï¼Ÿ')){ appState.records=[]; persist('ut_records',appState.records); renderRecords(); cloudSync('records'); }
};
renderRecords();

/* ==================== æ±ºç­–è¡¨ ==================== */
const conditionMap = {
  pattern: 'ç†Ÿæ‚‰çš„å½¢æ…‹',
  trend: 'è¶¨å‹¢',
  market: 'è·Ÿéš¨å¤§ç›¤',
  breakout: 'çªç ´äº¤æ˜“',
  draw: 'ç•«ç·šæª¢æŸ¥',
  kline: 'Kç·šå‹æ…‹',
};

function calculateIndividualKPIs() {
  const closedDecisions = appState.decisions.filter(d => d.result !== 'æœªåŸ·è¡Œ' && d.result !== '');
  const kpiData = {};
  const conditions = ['pattern', 'trend', 'market', 'breakout', 'draw', 'kline'];
  const ignoreValue = 'N/A';
  
  conditions.forEach(cond => { kpiData[cond] = {}; });

  closedDecisions.forEach(d => {
    conditions.forEach(cond => {
      const value = d[cond] || 'ç„¡';
      // åªçµ±è¨ˆé N/A çš„å€¼
      if(value === ignoreValue || value === '' || value === undefined) return;
      if (!kpiData[cond][value]) {
        kpiData[cond][value] = { wins: 0, losses: 0, total: 0, winRate: 'â€”' };
      }
      kpiData[cond][value].total++;
      if (d.result === 'ç›ˆ') kpiData[cond][value].wins++;
      else if (d.result === 'è™§') kpiData[cond][value].losses++;
    });
  });

  conditions.forEach(cond => {
    for (const value in kpiData[cond]) {
      const data = kpiData[cond][value];
      data.winRate = data.total > 0 ? (data.wins / data.total * 100).toFixed(1) + '%' : 'â€”';
    }
  });

  // RRR è¨ˆç®—ï¼šåªçµ±è¨ˆ result ç‚ºç›ˆæˆ–è™§çš„æ±ºç­–
  const rrrDecisions = closedDecisions.filter(d => (d.result === 'ç›ˆ' || d.result === 'è™§') && d.rrr);
  const rrrWins = rrrDecisions.filter(d => d.result === 'ç›ˆ' && parseFloat(d.rrr) >= 3).length;
  const rrrLosses = rrrDecisions.filter(d => d.result === 'è™§' && parseFloat(d.rrr) >= 3).length;
  const rrrTotal = rrrWins + rrrLosses;
  kpiData.rrr = { 'RRR >= 3': { wins: rrrWins, losses: rrrLosses, total: rrrTotal, winRate: rrrTotal > 0 ? (rrrWins / rrrTotal * 100).toFixed(1) + '%' : 'â€”' } };

  return kpiData;
}

function renderIndividualKPIs() {
  const kpiData = calculateIndividualKPIs();
  const container = document.getElementById('quant-dashboard-individual');
  container.innerHTML = '';

  for(const condKey in kpiData){
    const condTitle = conditionMap[condKey] || 'é¢¨å ±æ¯”';
    for(const valueKey in kpiData[condKey]){
      const data = kpiData[condKey][valueKey];
      const card = document.createElement('div');
      card.className = 'card';
      const color = data.winRate !== 'â€”' && parseFloat(data.winRate) >= 50 ? 'var(--accent)' : 'var(--danger)';
      card.innerHTML = `
        <div class=\"flex\"><span class=\"badge\">${condTitle} - ${valueKey}</span></div>
        <div class=\"kpi\" style=\"color:${color}\">${data.winRate}</div>
        <div class=\"hr\"></div>
        <small>ç¸½æ¬¡æ•¸: ${data.total} (ç›ˆ: ${data.wins} / è™§: ${data.losses})</small>`;
      container.appendChild(card);
    }
  }
}

function renderResonanceFilters() {
    const container = document.getElementById('resonance-filters');
    container.innerHTML = '';
    const conditionsToFilter = ['pattern', 'trend', 'market', 'breakout', 'draw', 'kline'];
    conditionsToFilter.forEach(cond => {
        const label = document.createElement('label');
        label.className = 'flex';
        label.style.cursor = 'pointer';
        label.innerHTML = `<input type=\"checkbox\" data-filter=\"${cond}\" style=\"margin-right:4px;\"> ${conditionMap[cond]}`;
        container.appendChild(label);
    });
}

function analyzeResonance() {
    // åªçµ±è¨ˆå·²åŸ·è¡Œçš„æ±ºç­–ï¼ˆçµæœç‚ºç›ˆæˆ–è™§ï¼‰
    const closedDecisions = appState.decisions.filter(d => d.result === 'ç›ˆ' || d.result === 'è™§');
    const activeFilters = Array.from(document.querySelectorAll('#resonance-filters input:checked')).map(cb => cb.dataset.filter);
    
    if (activeFilters.length === 0) {
        document.getElementById('resonance-result').innerHTML = '<span style="color:var(--muted)">è«‹å‹¾é¸è‡³å°‘ä¸€å€‹æ¢ä»¶</span>';
        return;
    }

    // ç¬¬ä¸€æ­¥ï¼šç¯©é¸æ‰€æœ‰å‹¾é¸æ¢ä»¶éƒ½ä¸æ˜¯ N/A çš„æ±ºç­–
    const decisionsToAnalyze = closedDecisions.filter(decision => {
        return activeFilters.every(filterKey => {
            const value = decision[filterKey];
            return value !== 'N/A' && value !== '' && value !== undefined;
        });
    });

    // ç¬¬äºŒæ­¥ï¼šå¾ç¯©é¸å¾Œçš„æ±ºç­–ä¸­ï¼Œæ‰¾å‡ºæ‰€æœ‰å‹¾é¸æ¢ä»¶éƒ½åŒ¹é…çš„æ±ºç­–
    const matchedDecisions = decisionsToAnalyze.filter(decision => {
        return activeFilters.every(filterKey => {
            const filterValue = document.getElementById(`qt-${filterKey}`).value;
            return decision[filterKey] === filterValue;
        });
    });

    const wins = matchedDecisions.filter(d => d.result === 'ç›ˆ').length;
    const losses = matchedDecisions.filter(d => d.result === 'è™§').length;
    const total = wins + losses;
    const winRate = total > 0 ? (wins / total * 100).toFixed(1) : 0;

    const resultEl = document.getElementById('resonance-result');
    const color = winRate >= 50 ? 'var(--accent)' : 'var(--danger)';
    resultEl.innerHTML = `
        <span style="color:${color}">å…±æŒ¯å‹ç‡: ${winRate}%</span>
        <small style="margin-left:8px; color:var(--muted)">(ç¬¦åˆ ${total} ç­†ï¼Œ${wins} ç›ˆ / ${losses} è™§ | ç¯©é¸ ${decisionsToAnalyze.length} ç­†)</small>
    `;
}

function setupQuantDashboard() {
    renderIndividualKPIs();
    renderResonanceFilters();
    document.getElementById('btn-analyze-resonance').onclick = analyzeResonance;
}

function renderQuant(){
  const tbody=document.querySelector('#tbl-quant tbody'); tbody.innerHTML='';
  appState.decisions.forEach((d,i)=>{
    const enterColor = d.enter==='æ˜¯' ? 'var(--accent)' : 'var(--danger)';
    
    let resultColor = 'var(--muted)';
    if(d.result === 'ç›ˆ'){ resultColor = 'var(--accent)'; }
    else if(d.result === 'è™§'){ resultColor = 'var(--danger)'; }

    const tr=document.createElement('tr');
    // ç¢ºä¿ RRR é¡¯ç¤ºç‚ºæ•¸å­—æˆ– â€”
    const rrrDisplay = d.rrr ? (typeof d.rrr === 'number' ? d.rrr.toFixed(2) : parseFloat(d.rrr).toFixed(2)) : 'â€”';
    
    tr.innerHTML=`
      <td>${i+1}</td><td>${d.asset}</td>
      <td>${d.pattern === 'N/A' ? 'æœªåƒè€ƒ' : d.pattern}</td>
      <td>${d.trend === 'N/A' ? 'æœªåƒè€ƒ' : d.trend}</td>
      <td>${d.market === 'N/A' ? 'æœªåƒè€ƒ' : d.market}</td>
      <td>${d.kline === 'N/A' ? 'æœªåƒè€ƒ' : d.kline || 'ç„¡'}</td>
      <td>${rrrDisplay}</td>
      <td>${d.breakout === 'N/A' ? 'æœªåƒè€ƒ' : d.breakout}</td>
      <td>${d.draw === 'N/A' ? 'æœªåƒè€ƒ' : d.draw}</td>
      <td style="color:${enterColor}">${d.enter}</td>
      <td><select class="input" style="width:100px;background-color:var(--panel);color:${resultColor}" data-result-idx="${i}">
        <option value="æœªåŸ·è¡Œ" ${d.result==='æœªåŸ·è¡Œ'?'selected':''}>æœªåŸ·è¡Œ</option>
        <option value="ç›ˆ" ${d.result==='ç›ˆ'?'selected':''}>ç›ˆ</option>
        <option value="è™§" ${d.result==='è™§'?'selected':''}>è™§</option>
      </select></td>
      <td>${d.note||''}</td>
      <td class="flex"><button class="btn danger" data-qdel="${i}">åˆªé™¤</button></td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('[data-qdel]').forEach(b=>{
    b.onclick=()=>{ appState.decisions.splice(+b.dataset.qdel,1); persist('ut_decisions',appState.decisions); renderQuant(); cloudSync('decisions'); setupQuantDashboard(); };
  });
  tbody.querySelectorAll('[data-result-idx]').forEach(select=>{
    select.onchange=(e)=>{
      const idx = +e.target.dataset.resultIdx;
      appState.decisions[idx].result = e.target.value;
      persist('ut_decisions',appState.decisions);
      renderQuant();
      cloudSync('decisions');
      setupQuantDashboard();
      updateDashboard(); // åŒæ™‚æ›´æ–°å„€è¡¨æ¿
    };
  });
  setupQuantDashboard();
}
document.getElementById('btn-add-decision').onclick=()=>{
  const d={ id:(Date.now().toString(36)+Math.random().toString(36).slice(2)),
    asset:(document.getElementById('qt-asset').value||'').toUpperCase(), 
    pattern:document.getElementById('qt-chk-pattern').checked ? document.getElementById('qt-pattern').value : 'N/A',
    trend:document.getElementById('qt-chk-trend').checked ? document.getElementById('qt-trend').value : 'N/A',
    market:document.getElementById('qt-chk-market').checked ? document.getElementById('qt-market').value : 'N/A',
    breakout:document.getElementById('qt-chk-breakout').checked ? document.getElementById('qt-breakout').value : 'N/A',
    draw:document.getElementById('qt-chk-draw').checked ? document.getElementById('qt-draw').value : 'N/A',
    kline:document.getElementById('qt-chk-kline').checked ? document.getElementById('qt-kline').value : 'N/A',
    rrr:+document.getElementById('qt-rrr').value||0, 
    enter:document.getElementById('qt-enter').value,
    note:document.getElementById('qt-note').value||'',
    result:'æœªåŸ·è¡Œ'
  };
  appState.decisions.unshift(d); persist('ut_decisions',appState.decisions); renderQuant(); cloudSync('decisions');
};
document.getElementById('btn-csv').onclick=()=>{
  const rows=[['#','asset','pattern','trend','market','kline','rrr','breakout','draw','enter','result','note']]; 
  appState.decisions.forEach((d,i)=>rows.push([i+1,d.asset,d.pattern,d.trend,d.market,d.kline||'ç„¡',d.rrr,d.breakout,d.draw,d.enter,d.result||'æœªåŸ·è¡Œ',d.note]));
  const csv=rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='quant-decisions.csv'; a.click(); URL.revokeObjectURL(url);
};
renderQuant();
setupQuantDashboard();

/* ==================== é›²ç«¯è¨­å®š ==================== */
document.getElementById("btn-save-cloud").onclick=async ()=>{
  const url=document.getElementById("sb-url").value.trim();
  const key=document.getElementById("sb-key").value.trim();
  if(!url||!key){ alert("è«‹å¡«å…¥ URL èˆ‡ Key"); return; }
  
  const success = await initSupabase(url, key);
  if (success) {
    appState.cloud={url,key,enabled:true}; 
    persist("ut_cloud",appState.cloud);
  }
};

document.getElementById('btn-clear-cloud').onclick=()=>{ 
  localStorage.removeItem('ut_cloud'); 
  appState.cloud=null; 
  isCloudEnabled = false;
  supabase = null;
  document.getElementById('sb-url').value = '';
  document.getElementById('sb-key').value = '';
  updateCloudStatus('æœªé€£ç·š - è³‡æ–™å­˜å„²åœ¨æœ¬æ©Ÿ');
  toast('å·²æ”¹ç”¨æœ¬æ©Ÿé›¢ç·šæ¨¡å¼ã€‚',2000); 
};

updateDashboard();
</script>
</body>
</html>
