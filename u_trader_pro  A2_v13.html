<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>U-Trader Pro Â· A2_v13</title>

<!-- TradingView -->
<script src="https://s3.tradingview.com/tv.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{--bg:#ffffff;--panel:#ffffff;--text:#0b1220;--muted:#667894;--primary:#2563eb;--accent:#16a34a;--danger:#dc2626;--border:#dbe2ee;--chip:#eef2f9}
[data-theme="dark"]{--bg:#000000;--panel:#121212;--text:#e6eefc;--muted:#93a4bf;--primary:#3b82f6;--accent:#22c55e;--danger:#ef4444;--border:#334155;--chip:#1e293b}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC",sans-serif}
.container{max-width:1200px;margin:32px auto;padding:0 16px}
.header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
.header .flex{flex-wrap:wrap;justify-content:flex-end}
.title{font-weight:800;font-size:20px}
.tabs{display:flex;gap:12px;flex-wrap:wrap}
.tab{padding:12px 14px;border:1px solid var(--border);border-radius:10px;background:var(--panel);color:var(--text);cursor:pointer;min-height:48px;display:inline-flex;align-items:center;justify-content:center}
.tab.active{outline:2px solid var(--primary)}
.theme{display:flex;gap:8px}
.btn{padding:12px 14px;border-radius:10px;border:1px solid var(--border);background:var(--panel);color:var(--text);cursor:pointer;min-height:40px;display:inline-flex;align-items:center;justify-content:center}
.btn:hover{background:var(--chip)}
.btn.primary{background:var(--primary);border-color:transparent;color:#fff}
.btn.danger{background:var(--danger);color:#fff;border-color:transparent}
.grid{display:grid;gap:12px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
h3{margin:0 0 10px 0;font-size:16px}
.row{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
.input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text)}
.quant-result{background:var(--panel);color:var(--text);-webkit-appearance:none;appearance:none;text-align:center;padding:10px 0}


small{color:var(--muted)}
.tbl{width:100%;border-collapse:collapse}
.tbl th,.tbl td{border-top:1px solid var(--border);padding:10px;text-align:left}
.tbl th{font-weight:700;color:var(--muted)}
.kpi{font-size:22px;font-weight:800}
.badge{padding:2px 8px;border-radius:999px;background:var(--border);font-size:12px;color:var(--muted)}
.flex{display:flex;gap:12px;align-items:center}
.right{justify-content:flex-end}
.hr{height:1px;background:var(--border);margin:8px 0}
.pills{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.pill{padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--border);cursor:pointer}
.pill.active{outline:2px solid var(--primary)}
.note{font-size:12px;color:var(--muted)}
.toast{position:fixed;right:16px;bottom:16px;background:var(--panel);border:1px solid var(--border);color:var(--text);padding:12px 14px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.25);max-width:360px;z-index:9999}
.section-toggle{cursor:pointer;user-select:none}
.section-toggle .arrow{display:inline-block;transform:rotate(0deg);transition:transform .2s}
.section-toggle.open .arrow{transform:rotate(90deg)}
.group-summary{font-weight:700}
.kpi-bar-wrap{margin-top:8px;border-radius:999px;background:rgba(148,163,184,.25);overflow:hidden;height:8px}
.kpi-bar{height:100%;width:0%;transition:width .3s}
.segment{display:inline-flex;border:1px solid var(--border);border-radius:10px;overflow:hidden;background:var(--panel)}
.segment button{border:0;padding:8px 12px;background:transparent;color:var(--text);cursor:pointer}
.segment button.active{background:var(--primary);color:#fff}
.indicator-toggles{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
.indicator-toggles label{display:inline-flex;align-items:center;gap:6px;font-size:13px;background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:999px;cursor:pointer}

@media (max-width: 768px) {
  .container { padding: 0 8px; margin: 12px auto; }
  .header { flex-direction: column; gap: 8px; }
  .tabs { width: 100%; justify-content: center; }
  .tab { padding: 8px 10px; font-size: 12px; }
  .row { grid-template-columns: 1fr !important; }
  .row > div[style*="grid-column"] { grid-column: span 12 !important; }
  .btn { padding: 8px 10px; font-size: 13px; }
  .tbl { font-size: 11px; overflow-x:auto; display:block; white-space:nowrap; }
  #tv-container{height:400px!important}
  .kpi{font-size:18px}
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title"><strong style="font-size: 22px; font-weight: 900;">U-Trader Pro</strong><span style="font-size: 14px; margin-left: 8px; opacity: 0.8;">A2_ v13</span></div>
    <div class="flex">
      <div class="tabs" id="tabs">
        <button class="tab active" data-page="p-dashboard">å„€è¡¨æ¿</button>
        <button class="tab" data-page="p-market">ç›¤é¢åƒè€ƒ</button>
        <button class="tab" data-page="p-sim">æ¨¡æ“¬è©¦ç®—</button>
        <button class="tab" data-page="p-records">å¯¦éš›äº¤æ˜“ç´€éŒ„</button>
        <button class="tab" data-page="p-quant">é‡åŒ–æ±ºç­–</button>
        <button class="tab" data-page="p-cloud">è¨­å®šï¼ˆé›²ç«¯ï¼‰</button>
      </div>
      <div class="theme">
        <button class="btn" id="lightBtn">æ·ºè‰²</button>
        <button class="btn" id="darkBtn">æ·±è‰²</button>
      </div>
    </div>
  </div>

  <!-- å„€è¡¨æ¿ -->
  <section id="p-dashboard" class="card">
    <h3>ğŸ“Š äº¤æ˜“ç¸¾æ•ˆç¸½è¦½</h3>
    <div class="row" style="margin-bottom:12px;align-items:flex-end">
      <div style="grid-column:span 3">
        <label>é–‹å§‹æ—¥æœŸ</label>
        <input class="input" type="date" id="filter-start-date" />
      </div>
      <div style="grid-column:span 3">
        <label>çµæŸæ—¥æœŸ</label>
        <input class="input" type="date" id="filter-end-date" />
      </div>
      <div style="grid-column:span 6" class="right">
        <label>ç¯©é¸</label><br/>
        <div class="segment" id="scopeSeg">
          <button data-scope="all" class="active">å…¨éƒ¨</button>
          <button data-scope="self">è‡ªå·±</button>
          <button data-scope="copy">è·Ÿå–®</button>
        </div>
      </div>
    </div>
    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr))">
      <div class="card">
        <div class="flex"><span class="badge">åˆå§‹è³‡é‡‘ (USDT)</span></div>
        <input id="init-balance" type="number" step="any" class="input" value="1000" style="margin-top:8px"/>
      </div>
      <div class="card">
        <div class="flex"><span class="badge">ç›®å‰è³‡é‡‘ (USDT)</span></div>
        <div class="kpi" id="balanceDisplay">0.00</div>
      </div>
      <div class="card">
        <div class="flex"><span class="badge">ç¸½äº¤æ˜“æ¬¡æ•¸</span></div>
        <div class="kpi" id="dash-total">0</div>
      </div>
      <div class="card">
        <div class="flex"><span class="badge">ç¸½ç›ˆè™§ (USDT)</span></div>
        <div class="kpi" id="dash-pl">0.00</div>
      </div>
      <div class="card">
        <div class="flex"><span class="badge">å‹ç‡</span></div>
        <div class="kpi" id="dash-winrate">0%</div>
      </div>
      <div class="card">
        <div class="flex"><span class="badge">å¹³å‡ RRR</span></div>
        <div class="kpi" id="dash-rrr">0.00</div>
      </div>
      <div class="card">
        <div class="flex"><span class="badge">æœ€å¤§å–®ç­†ç›ˆåˆ©</span></div>
        <div class="kpi" id="dash-maxwin" style="color:var(--accent)">0.00</div>
      </div>
      <div class="card">
        <div class="flex"><span class="badge">æœ€å¤§å–®ç­†è™§æ</span></div>
        <div class="kpi" id="dash-maxloss" style="color:var(--danger)">0.00</div>
      </div>
    </div>
    <div class="flex right" style="margin-top:8px">
      <button class="btn" id="btn-rerun-stats">ğŸ”„ é‡æ–°çµ±è¨ˆ</button>
    </div>
    <small style="margin-top:12px;display:block">å‹ç‡ = ç›ˆåˆ©å–® Ã· å·²å¹³å€‰å–®ã€‚æ–°å¢ã€ä¿®æ”¹ã€åˆªé™¤å¾Œå³æ™‚æ›´æ–°ã€‚</small>

    <div class="hr" style="margin-top:20px;margin-bottom:20px"></div>

    <h3>ğŸ“ˆ ç­–ç•¥ç¸¾æ•ˆåˆ†çµ„ (S1-S6)</h3>
    <div class="grid" id="strategy-kpis" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr))">
      <!-- Strategy KPIs will be rendered here -->
    </div>
    <div style="margin-top:12px">
      <small>æœ€ä½³ç­–ç•¥: <span id="best-strategy" style="font-weight:700">N/A</span> (å‹ç‡: <span id="best-strategy-winrate">0%</span>)</small><br/>
      <small>æœ€å·®ç­–ç•¥: <span id="worst-strategy" style="font-weight:700">N/A</span> (å‹ç‡: <span id="worst-strategy-winrate">0%</span>)</small>
    </div>
  </section>

  <!-- ç›¤é¢åƒè€ƒ -->
  <section id="p-market" class="card" style="display:none">
    <h3>TradingView å°å·¥å…·</h3>

    <div class="indicator-toggles" id="indicatorToggles">
      <label><input type="checkbox" data-study="STD;RSI"> RSI</label>
      <label><input type="checkbox" data-study="STD;MACD"> MACD</label>
      <label><input type="checkbox" data-study="STD;Stochastic_RSI"> Stoch RSI</label>
      <label><input type="checkbox" data-study="STD;Volume"> Volume</label>
      <button class="btn" id="btn-apply-studies">å¥—ç”¨æŒ‡æ¨™</button>
    </div>

    <div style="margin-bottom:12px">
      <div class="flex" style="flex-wrap:wrap;gap:8px;margin-bottom:6px;align-items:center">
        <span class="badge">ğŸŸ¡ å¹£å®‰</span>
        <button class="btn" data-preset="BINANCE:BTCUSDT">BTC</button>
        <button class="btn" data-preset="BINANCE:ETHUSDT">ETH</button>
        <button class="btn" data-preset="BINANCE:SOLUSDT">SOL</button>
        <button class="btn" data-preset="BINANCE:BNBUSDT">BNB</button>
        <button class="btn" data-preset="BINANCE:ADAUSDT">ADA</button>
      </div>
      <div class="flex" style="flex-wrap:wrap;gap:8px;margin-bottom:6px;align-items:center">
        <span class="badge">ğŸŸ  Bybit</span>
        <button class="btn" data-preset="BYBIT:BTCUSDT">BTC</button>
        <button class="btn" data-preset="BYBIT:ETHUSDT">ETH</button>
        <button class="btn" data-preset="BYBIT:SOLUSDT">SOL</button>
        <button class="btn" data-preset="BYBIT:XRPUSDT">XRP</button>
        <button class="btn" data-preset="BYBIT:DOGEUSDT">DOGE</button>
      </div>
      <div class="flex" style="flex-wrap:wrap;gap:8px;margin-bottom:6px;align-items:center">
        <span class="badge">âš« OKX</span>
        <button class="btn" data-preset="OKX:BTCUSDT.P">BTC</button>
        <button class="btn" data-preset="OKX:ETHUSDT.P">ETH</button>
        <button class="btn" data-preset="OKX:SOLUSDT.P">SOL</button>
        <button class="btn" data-preset="OKX:AVAXUSDT.P">AVAX</button>
        <button class="btn" data-preset="OKX:DOTUSDT.P">DOT</button>
      </div>
      <div class="flex" style="flex-wrap:wrap;gap:8px;margin-bottom:6px;align-items:center">
        <span class="badge">ğŸ”µ Pionex</span>
        <button class="btn" data-preset="PIONEX:BTCUSDT.P">BTC</button>
        <button class="btn" data-preset="PIONEX:ETHUSDT.P">ETH</button>
        <button class="btn" data-preset="PIONEX:SOLUSDT.P">SOL</button>
        <button class="btn" data-preset="PIONEX:BNBUSDT.P">BNB</button>
        <button class="btn" data-preset="PIONEX:ZECUSDT.P">ZEC</button>
      </div>
      <div class="flex" style="flex-wrap:wrap;gap:8px;align-items:center">
        <span class="badge">ğŸ”´ BingX</span>
        <button class="btn" data-preset="BINGX:BTCUSDT.P">BTC</button>
        <button class="btn" data-preset="BINGX:ETHUSDT.P">ETH</button>
        <button class="btn" data-preset="BINGX:SOLUSDT.P">SOL</button>
        <button class="btn" data-preset="BINGX:XRPUSDT.P">XRP</button>
        <button class="btn" data-preset="BINGX:DOGEUSDT.P">DOGE</button>
      </div>
    </div>

    <div class="row" style="margin-bottom:12px">
      <div style="grid-column:span 4">
        <label>ä¸»äº¤æ˜“æ‰€ / Symbol</label>
        <input class="input" id="tv-symbol" value="BINANCE:BTCUSDT" />
      </div>
      <div style="grid-column:span 4">
        <label>æ™‚é–“æ¡†æ¶</label>
        <select class="input" id="tv-interval">
          <option value="1">1m</option><option value="5">5m</option><option value="15">15m</option>
          <option value="60" selected>1h</option><option value="240">4h</option><option value="D">1D</option>
          <option value="W">1W</option><option value="M">1M</option>
        </select>
      </div>
      <div style="grid-column:span 4" class="flex right">
        <button class="btn primary" id="tv-apply" style="margin-top:20px">å¥—ç”¨</button>
      </div>
    </div>

    <div class="hr"></div>

    <div class="row" style="margin-top:12px">
      <div style="grid-column:span 8">
        <label>è§€å¯Ÿæ¸…å–® (ä¸€è¡Œä¸€å€‹)</label>
        <textarea class="input" id="watchlist" rows="5">BINANCE:BTCUSDT
BINANCE:ETHUSDT
BINANCE:SOLUSDT</textarea>
      </div>
      <div style="grid-column:span 4" class="flex right">
        <button class="btn" id="btn-apply-watch" style="margin-top:20px">ç”Ÿæˆè§€å¯Ÿæ¸…å–®æ¨™ç±¤</button>
      </div>
    </div>
    <div class="pills" id="watch-pills">
      <!-- Watchlist pills will be rendered here -->
    </div>

    <div class="hr" style="margin-top:20px"></div>

    <div id="tv-container" style="height:560px;margin-top:16px">
      <!-- TradingView Widget will be rendered here -->
    </div>
  </section>

  <!-- æ¨¡æ“¬è©¦ç®— -->
  <section id="p-sim" class="card" style="display:none">
    <h3>ğŸ§ª æ¨¡æ“¬äº¤æ˜“è©¦ç®—</h3>
    <div class="row">
      <div style="grid-column:span 3">
        <label>äº¤æ˜“å¹£ç¨®</label>
        <input class="input" id="sim-asset" value="BTCUSDT" data-calc="true" />
      </div>
      <div style="grid-column:span 3">
        <label>æ§“æ¡¿å€æ•¸</label>
        <input class="input" type="number" id="sim-lev" value="10" min="1" data-calc="true" />
      </div>
      <div style="grid-column:span 3">
        <label>æŠ•å…¥æœ¬é‡‘ (USDT)</label>
        <input class="input" type="number" id="sim-capital" value="100" min="1" data-calc="true" />
      </div>
      <div style="grid-column:span 3">
        <label>æ–¹å‘</label>
        <select class="input" id="sim-side" data-calc="true">
          <option value="å¤š">å¤š</option>
          <option value="ç©º">ç©º</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <div style="grid-column:span 3">
        <label>é€²å ´åƒ¹æ ¼</label>
        <input class="input" type="number" step="any" id="sim-entry-price" value="30000" data-calc="true" />
      </div>
      <div style="grid-column:span 3">
        <label>TP %</label>
        <input class="input" type="number" step="any" id="sim-tp-percent" value="1.5" data-calc="true" />
      </div>
      <div style="grid-column:span 3">
        <label>SL %</label>
        <input class="input" type="number" step="any" id="sim-sl-percent" value="0.5" data-calc="true" />
      </div>
      <div style="grid-column:span 3">
        <label>æ‰‹çºŒè²»ç‡ (%)</label>
        <input class="input" type="number" step="any" id="sim-fee" value="0.05" data-calc="true" />
      </div>
    </div>

    <div class="hr" style="margin-top:20px;margin-bottom:20px"></div>

    <h3>ğŸ“Š è©¦ç®—çµæœ</h3>
    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr))">
      <div class="card">
        <div class="flex"><span class="badge">åç¾©å€‰ä½ (USDT)</span></div>
        <div class="kpi" id="sim-notional">0.00</div>
      </div>
      <div class="card">
        <div class="flex"><span class="badge">å€‰ä½æ•¸é‡ (Coin)</span></div>
        <div class="kpi" id="sim-size">0.00</div>
      </div>
      <div class="card">
        <div class="flex"><span class="badge">é è¨ˆ TP åƒ¹æ ¼</span></div>
        <div class="kpi" id="sim-tp">0.00</div>
      </div>
      <div class="card">
        <div class="flex"><span class="badge">é è¨ˆ SL åƒ¹æ ¼</span></div>
        <div class="kpi" id="sim-sl">0.00</div>
      </div>
      <div class="card">
        <div class="flex"><span class="badge">é è¨ˆç›ˆè™§ (USDT)</span></div>
        <div class="kpi" id="sim-pl">0.00</div>
      </div>
      <div class="card">
        <div class="flex"><span class="badge">é è¨ˆ RRR</span></div>
        <div class="kpi" id="sim-rrr">0.00</div>
      </div>
    </div>

    <div class="hr" style="margin-top:20px;margin-bottom:20px"></div>

    <h3>âš ï¸ å€‰ä½é¢¨éšªè©¦ç®—</h3>
    <div class="row">
      <div style="grid-column:span 3">
        <label>æœ€å¤§è™§æ (USDT)</label>
        <input class="input" id="risk-max-loss" readonly />
      </div>
      <div style="grid-column:span 3">
        <label>çˆ†å€‰è·é›¢ (%)</label>
        <input class="input" id="risk-liq-dist" readonly />
      </div>
      <div style="grid-column:span 3">
        <label>é¢¨éšªç­‰ç´š</label>
        <input class="input" id="risk-level" readonly />
      </div>
      <div style="grid-column:span 3" class="flex right">
        <button class="btn primary" id="btn-to-record" style="margin-top:20px">å¸¶å…¥äº¤æ˜“ç´€éŒ„</button>
      </div>
    </div>
    <small style="margin-top:8px;display:block">é¢¨éšªç­‰ç´šï¼šä½ (â‰¤ 2%) / æ³¨æ„ (2% < x â‰¤ 5%) / é«˜ (> 5%)</small>
  </section>

  <!-- å¯¦éš›äº¤æ˜“ç´€éŒ„ -->
  <section id="p-records" class="card" style="display:none">
    <h3>ğŸ“ æ–°å¢ / ä¿®æ”¹äº¤æ˜“ç´€éŒ„</h3>
    <div class="row">
      <div style="grid-column:span 3">
        <label>äº¤æ˜“å¹£ç¨®</label>
        <input class="input" id="rec-asset" value="BTCUSDT" />
      </div>
      <div style="grid-column:span 3">
        <label>æŠ•å…¥æœ¬é‡‘ (USDT)</label>
        <input class="input" type="number" step="any" id="rec-invest" value="100" min="1" />
      </div>
      <div style="grid-column:span 3">
        <label>æ§“æ¡¿å€æ•¸</label>
        <input class="input" type="number" id="rec-lev" value="10" min="1" />
      </div>
      <div style="grid-column:span 3">
        <label>æ–¹å‘</label>
        <select class="input" id="rec-side">
          <option value="å¤š">å¤š</option>
          <option value="ç©º">ç©º</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <div style="grid-column:span 3">
        <label>ç­–ç•¥åˆ†é¡ (Strategy Type)</label>
        <select class="input" id="rec-strategy-type">
          <option value="">è«‹é¸æ“‡ (å¿…å¡«)</option>
          <option value="S1">S1: ç†Šå¸‚åå½ˆç©º (Retracement Short)</option>
          <option value="S2">S2: æ”¯æ’ç ´ä½ç©º (Breakdown Short)</option>
          <option value="S3">S3: å‡è·Œç ´å¤š (Fake-break Long)</option>
          <option value="S4">S4: ç®±é«”ä¸Šä¸‹ç·£ (Range Long/Short)</option>
          <option value="S5">S5: ç¾è²¨ç¶²æ ¼ (Grid Spot DCA)</option>
          <option value="S6">S6: æ¥µç«¯ææ…Œåå½ˆ (Capitulation Long)</option>
        </select>
      </div>
      <div style="grid-column:span 3">
        <label>æ™‚é–“æ¡†æ¶</label>
        <input class="input" id="rec-timeframe" value="1h" />
      </div>
      <div style="grid-column:span 3">
        <label>é€²å ´åƒ¹æ ¼</label>
        <input class="input" type="number" step="any" id="rec-open" value="30000" />
      </div>
      <div style="grid-column:span 3">
        <label>é è¨ˆ TP åƒ¹æ ¼</label>
        <input class="input" type="number" step="any" id="rec-tp" value="30450" />
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <div style="grid-column:span 3">
        <label>é è¨ˆ SL åƒ¹æ ¼</label>
        <input class="input" type="number" step="any" id="rec-sl" value="29850" />
      </div>
      <div style="grid-column:span 3">
        <label>å¯¦éš› RRR</label>
        <input class="input" id="rec-rrr" readonly />
      </div>
      <div style="grid-column:span 3">
        <label>æ˜¯å¦å·²å¹³å€‰</label>
        <select class="input" id="rec-closed">
          <option value="å¦">å¦ (æœªå¹³å€‰)</option>
          <option value="æ˜¯">æ˜¯ (å·²å¹³å€‰)</option>
        </select>
      </div>
      <div style="grid-column:span 3">
        <label>å¹³å€‰åƒ¹æ ¼</label>
        <input class="input" type="number" step="any" id="rec-close" value="0" />
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <div style="grid-column:span 3">
        <label>å¯¦éš›ç›ˆè™§ (USDT)</label>
        <div class="flex">
          <input class="input" type="number" step="any" id="rec-pl" value="0" />
          <button class="btn" id="pl-plus" style="flex-shrink:0">+</button>
          <button class="btn" id="pl-minus" style="flex-shrink:0">-</button>
        </div>
      </div>
      <div style="grid-column:span 3">
        <label>æ‰‹çºŒè²» (USDT)</label>
        <input class="input" type="number" step="any" id="rec-fee" value="0" />
      </div>
      <div style="grid-column:span 3">
        <label>äº¤æ˜“é¡å‹</label>
        <select class="input" id="rec-iscopy">
          <option value="false">è‡ªå·±</option>
          <option value="true">è·Ÿå–®</option>
        </select>
      </div>
      <div style="grid-column:span 3">
        <label>é‡åŒ–æ±ºç­–æ˜¯å¦é€²å ´</label>
        <select class="input" id="rec-quant-enter">
          <option value="å¦">å¦</option>
          <option value="æ˜¯">æ˜¯</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <div style="grid-column:span 6">
        <label>é–‹å€‰æ™‚é–“</label>
        <input class="input" id="rec-open-time" readonly />
      </div>
      <div style="grid-column:span 6">
        <label>å¹³å€‰æ™‚é–“</label>
        <input class="input" id="rec-close-time" readonly />
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <div style="grid-column:span 12">
        <label>äº¤æ˜“å‚™è¨» / ç†ç”±</label>
        <textarea class="input" id="rec-reason" rows="3"></textarea>
      </div>
    </div>
    <div class="flex right" style="margin-top:12px">
      <button class="btn" id="btn-reset-form">é‡è¨­è¡¨å–®</button>
      <button class="btn danger" id="btn-clear-records">æ¸…ç©ºæœ¬æ©Ÿç´€éŒ„</button>
      <button class="btn" id="btn-export-records">åŒ¯å‡º CSV</button>
      <button class="btn primary" id="btn-add-record">æ–°å¢ / æ›´æ–°ç´€éŒ„</button>
    </div>

    <div class="hr" style="margin-top:20px;margin-bottom:20px"></div>

    <h3>ğŸ“œ äº¤æ˜“ç´€éŒ„åˆ—è¡¨</h3>
    <div style="overflow-x:auto">
      <table class="tbl" id="tbl-records">
        <thead>
          <tr>
            <th>#</th><th>é–‹å€‰æ™‚é–“</th><th>å¹³å€‰æ™‚é–“</th><th>æŒå€‰(åˆ†)</th><th>é¡å‹</th><th>å¹£ç¨®</th><th>æœ¬é‡‘</th><th>æ§“æ¡¿</th><th>æ–¹å‘</th><th>ç­–ç•¥</th><th>æ™‚æ¡†</th><th>é€²å ´åƒ¹</th><th>TPåƒ¹</th><th>SLåƒ¹</th><th>RRR</th><th>å¹³å€‰?</th><th>å¹³å€‰åƒ¹</th><th>ç›ˆè™§(USDT)</th><th>æ‰‹çºŒè²»</th><th>å‚™è¨»</th><th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          <!-- Records will be rendered here -->
        </tbody>
      </table>
    </div>
  </section>

  <!-- é‡åŒ–æ±ºç­– -->
  <section id="p-quant" class="card" style="display:none">
    <h3>ğŸ§  é‡åŒ–æ±ºç­–å› å­è¼¸å…¥</h3>
    <div class="row">
      <div style="grid-column:span 3">
        <label>äº¤æ˜“å¹£ç¨®</label>
        <input class="input" id="qt-asset" value="BTCUSDT" />
      </div>
      <div style="grid-column:span 3">
        <label>ç†Ÿæ‚‰å½¢æ…‹</label>
        <select class="input" id="qt-pattern">
          <option value="æ˜¯">æ˜¯</option>
          <option value="å¦">å¦</option>
        </select>
      </div>
      <div style="grid-column:span 3">
        <label>è¶¨å‹¢</label>
        <select class="input" id="qt-trend">
          <option value="ä¸Šè¡Œ">ä¸Šè¡Œ</option>
          <option value="ä¸‹è¡Œ">ä¸‹è¡Œ</option>
          <option value="ç›¤æ•´">ç›¤æ•´</option>
        </select>
      </div>
      <div style="grid-column:span 3">
        <label>è·Ÿå¤§ç›¤</label>
        <select class="input" id="qt-market">
          <option value="æ˜¯">æ˜¯</option>
          <option value="å¦">å¦</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <div style="grid-column:span 3">
        <label>çªç ´äº¤æ˜“</label>
        <select class="input" id="qt-breakout">
          <option value="æ¿€é€²">æ¿€é€²</option>
          <option value="ä¿å®ˆ">ä¿å®ˆ</option>
          <option value="å¦">å¦</option>
        </select>
      </div>
      <div style="grid-column:span 3">
        <label>ç•«ç·š</label>
        <select class="input" id="qt-draw">
          <option value="æ˜¯">æ˜¯</option>
          <option value="å¦">å¦</option>
        </select>
      </div>
      <div style="grid-column:span 3">
        <label>å‡ç·š</label>
        <select class="input" id="qt-ma">
          <option value="æœªåƒè€ƒ">æœªåƒè€ƒ</option>
          <option value="é †å‹¢">é †å‹¢</option>
          <option value="é€†å‹¢">é€†å‹¢</option>
        </select>
      </div>
      <div style="grid-column:span 3">
        <label>é è¨ˆ RRR</label>
        <input class="input" type="number" step="any" id="qt-rrr" value="1.5" min="0.1" />
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <div style="grid-column:span 9">
        <label>K ç·šçµ„åˆ (å¤šé¸)</label>
        <div class="pills" id="qt-kline-pills">
          <span class="pill" data-value="åå™¬">åå™¬</span>
          <span class="pill" data-value="æ—©æ™¨ä¹‹æ˜Ÿ">æ—©æ™¨ä¹‹æ˜Ÿ</span>
          <span class="pill" data-value="éŒ˜å­">éŒ˜å­</span>
          <span class="pill" data-value="æµæ˜Ÿ">æµæ˜Ÿ</span>
          <span class="pill" data-value="çœ‹æ¼²åæ²’">çœ‹æ¼²åæ²’</span>
          <span class="pill" data-value="çœ‹è·Œåæ²’">çœ‹è·Œåæ²’</span>
        </div>
        <input type="hidden" id="qt-kline" value="" />
      </div>
      <div style="grid-column:span 3">
        <label>æ˜¯å¦é€²å ´ (ç³»çµ±å»ºè­°)</label>
        <select class="input" id="qt-enter">
          <option value="æ˜¯">æ˜¯</option>
          <option value="å¦">å¦</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <div style="grid-column:span 9">
        <label>å‚™è¨»</label>
        <input class="input" id="qt-note" />
      </div>
      <div style="grid-column:span 3" class="flex right">
        <button class="btn" id="btn-export-quant-csv">åŒ¯å‡º CSV</button>
        <button class="btn primary" id="btn-add-decision">æ–°å¢æ±ºç­–</button>
      </div>
    </div>

    <div class="hr" style="margin-top:20px;margin-bottom:20px"></div>

    <div class="row">
      <div style="grid-column:span 8">
        <h3>ğŸ“œ æ±ºç­–ç´€éŒ„åˆ—è¡¨</h3>
        <div style="overflow-x:auto">
          <table class="tbl" id="tbl-quant">
            <thead>
              <tr>
                <th>#</th><th>å¹£ç¨®</th><th>å½¢æ…‹</th><th>è¶¨å‹¢</th><th>å¤§ç›¤</th><th>Kç·š</th><th>å‡ç·š</th><th>çªç ´</th><th>ç•«ç·š</th><th>RRR</th><th>é€²å ´</th><th>çµæœ</th><th>å‚™è¨»</th><th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              <!-- Quant decisions will be rendered here -->
            </tbody>
          </table>
        </div>
      </div>
      <div style="grid-column:span 4">
        <h3>ğŸ† æœ€ä½³å…±æŒ¯çµ„åˆ (Top 3)</h3>
        <ul id="comboList" style="list-style:none;padding:0">
          <!-- Top combos will be rendered here -->
        </ul>
        <small class="note">åƒ…çµ±è¨ˆã€Œé€²å ´=æ˜¯ã€ä¸”ã€Œçµæœ=å‹/æ•—ã€çš„æ±ºç­–ã€‚</small>
      </div>
    </div>
  </section>

  <!-- é›²ç«¯è¨­å®š -->
  <section id="p-cloud" class="card" style="display:none">
    <h3>â˜ï¸ Supabase é›²ç«¯åŒæ­¥è¨­å®š</h3>
    <div class="row">
      <div style="grid-column:span 6">
        <label>Supabase URL</label>
        <input class="input" id="sb-url" placeholder="e.g., https://xyz.supabase.co" />
      </div>
      <div style="grid-column:span 6">
        <label>Supabase Anon Key</label>
        <input class="input" id="sb-key" placeholder="e.g., eyJhbGciOiJIUzI1Ni..." />
      </div>
    </div>
    <div class="flex right" style="margin-top:12px">
      <button class="btn danger" id="btn-disable-cloud" style="display:none">åœç”¨é›²ç«¯åŒæ­¥</button>
      <button class="btn primary" id="btn-enable-cloud">å•Ÿç”¨é›²ç«¯åŒæ­¥</button>
    </div>
    <small style="margin-top:12px;display:block">è‹¥æœªå•Ÿç”¨é›²ç«¯ï¼Œæ‰€æœ‰è³‡æ–™åƒ…å„²å­˜åœ¨ç€è¦½å™¨æœ¬æ©Ÿ (localStorage)ã€‚</small>
  </section>

  <!-- Debug Panel (Spec 11.2) -->
  <div id="debug-panel" class="toast" style="display:none;right:16px;top:16px;bottom:auto;max-width:280px;padding:10px;z-index:9999">
    <h4 style="margin:0 0 8px 0;font-size:14px">ğŸ› ï¸ Debug Mode (v8.6.5_A2)</h4>
    <small>Records: <span id="debug-records-count">0</span></small><br/>
    <small>Decisions: <span id="debug-decisions-count">0</span></small><br/>
    <small>Main WinRate: <span id="debug-main-winrate">0%</span></small><br/>
    <small>S1 WinRate: <span id="debug-s1-winrate">0%</span></small><br/>
    <small>S6 WinRate: <span id="debug-s6-winrate">0%</span></small><br/>
    <small>Local Sync: <span id="debug-local-sync" style="color:var(--accent)">OK</span></small><br/>
    <small>Cloud Sync: <span id="debug-cloud-sync" style="color:var(--danger)">Disabled</span></small>
  </div>

</div>

<script>
// å…¨å±€è¨­å®š
const DEBUG_MODE = false; // Spec 11.1 - é è¨­é—œé–‰ï¼Œå¦‚éœ€åµéŒ¯è«‹æ”¹ç‚º true
const STRATEGY_TYPES = {
  'S1': 'ç†Šå¸‚åå½ˆç©º (Retracement Short)',
  'S2': 'æ”¯æ’ç ´ä½ç©º (Breakdown Short)',
  'S3': 'å‡è·Œç ´å¤š (Fake-break Long)',
  'S4': 'ç®±é«”ä¸Šä¸‹ç·£ (Range Long/Short)',
  'S5': 'ç¾è²¨ç¶²æ ¼ (Grid Spot DCA)',
  'S6': 'æ¥µç«¯ææ…Œåå½ˆ (Capitulation Long)'
};

// å…¨å±€ç‹€æ…‹
const appState = {
  records: [],
  decisions: [],
  cloud: null,
  studies: [],
  dashboardScope: 'all',
  tvWidget: null,
  supabaseClient: null,
  isCloudEnabled: false,
};
let currentEditId = null;
let weeklyFlagDate = localStorage.getItem('ut_weeklyFlagDate') || '';

// è¼”åŠ©å‡½æ•¸
const $ = (s) => document.querySelector(s);
const $$ = (s) => document.querySelectorAll(s);
const safeBind = (id, event, handler) => {
  const el = $(`#${id}`);
  if (el) el.addEventListener(event, handler);
};
const toast = (msg, duration = 2000) => {
  let t = $('#toast');
  if (!t) {
    t = document.createElement('div');
    t.id = 'toast';
    t.className = 'toast';
    document.body.appendChild(t);
  }
  t.textContent = msg;
  t.style.display = 'block';
  setTimeout(() => { t.style.display = 'none'; }, duration);
};

// è³‡æ–™æŒä¹…åŒ–
const persist = (key, data) => {
  localStorage.setItem(key, JSON.stringify(data));
  if (appState.isCloudEnabled && appState.supabaseClient) {
    syncToSupabase(key, data);
  }
};
const retrieve = (key) => {
  const data = localStorage.getItem(key);
  try {
    return data ? JSON.parse(data) : null;
  } catch (e) {
    console.error(`Error parsing localStorage key ${key}:`, e);
    return null;
  }
};

// è³‡æ–™çµæ§‹æ­£è¦åŒ– (Spec 4.1)
function normalizeRecords(records) {
  return records.map(r => {
    const isClosed = r.closed === 'æ˜¯' || r.isClosed === true;
    const pl = +r.profit || +r.pl || 0;
    const rrr = +r.rrr || 0;
    const result = pl > 0 ? 'ç›ˆ' : (pl < 0 ? 'è™§' : 'å¹³');

    return {
      id: r.id || (Date.now().toString(36) + Math.random().toString(36).slice(2)),
      symbol: (r.asset || r.symbol || '').toUpperCase(),
      direction: r.side === 'ç©º' ? 'ç©º' : 'å¤š',
      strategy_type: r.strategy_type || 'S1',
      setup_description: r.reason || r.comment || '',
      entry_price: +r.open || +r.entry_price || 0,
      exit_price: +r.close || +r.exit_price || 0,
      leverage: +r.lev || +r.leverage || 1,
      capital: +r.invest || +r.capital || 0,
      rrr: rrr,
      profit: pl,
      isCopy: r.isCopy === true || r.isCopy === 'è·Ÿå–®',
      isClosed: isClosed,
      openTime: r.openTime || new Date().toISOString(),
      closeTime: isClosed ? (r.closeTime || new Date().toISOString()) : null,
      comment: r.reason || r.comment || '',
      timeframe: r.timeframe || '1h',
      feeRate: +r.fee || +r.feeRate || 0,
      // èˆŠç‰ˆç›¸å®¹æ¬„ä½ (ç”¨æ–¼ UI ç¶å®š)
      asset: (r.asset || r.symbol || '').toUpperCase(),
      side: r.side === 'ç©º' ? 'ç©º' : 'å¤š',
      lev: +r.lev || +r.leverage || 1,
      open: +r.open || +r.entry_price || 0,
      tp: +r.tp || 0, // é è¨ˆ TP åƒ¹æ ¼
      sl: +r.sl || 0, // é è¨ˆ SL åƒ¹æ ¼
      closed: isClosed ? 'æ˜¯' : 'å¦',
      close: +r.close || +r.exit_price || 0,
      pl: pl,
      fee: +r.fee || +r.feeRate || 0,
      reason: r.reason || r.comment || '',
      result: result,
      quantEnter: r.quantEnter || 'å¦',
      invest: +r.invest || +r.capital || 0,
    };
  });
}

// æ¨¡æ“¬è©¦ç®—é‚è¼¯ (Spec 7)
function recalcSim() {
  const entry = +$('#sim-entry-price').value || 0;
  const tpPct = +$('#sim-tp-percent').value / 100 || 0;
  const slPct = +$('#sim-sl-percent').value / 100 || 0;
  const side = $('#sim-side').value;
  const lev = +$('#sim-lev').value || 1;
  const capital = +$('#sim-capital').value || 0;
  const feePct = +$('#sim-fee').value / 100 || 0;

  if (entry <= 0) {
    $('#sim-notional').textContent = '0.00';
    $('#sim-size').textContent = '0.00';
    $('#sim-tp').textContent = '0.00';
    $('#sim-sl').textContent = '0.00';
    $('#sim-pl').textContent = '0.00';
    $('#sim-rrr').textContent = '0.00';
    updateRiskHint();
    return;
  }

  let tpPrice, slPrice, pl;

  // åç¾©å€‰ä½ (Notional)
  const notional = capital * lev;
  // å€‰ä½æ•¸é‡ (Size)
  const size = notional / entry;

  // é è¨ˆ TP/SL åƒ¹æ ¼ (Spec 4)
  if (side === 'å¤š') {
    tpPrice = entry * (1 + tpPct / lev);
    slPrice = entry * (1 - slPct / lev);
    pl = notional * tpPct - capital * feePct * 2; // é è¨ˆç›ˆè™§ (è€ƒæ…®æ‰‹çºŒè²»)
  } else { // ç©º
    tpPrice = entry * (1 - tpPct / lev);
    slPrice = entry * (1 + slPct / lev);
    pl = notional * tpPct - capital * feePct * 2; // é è¨ˆç›ˆè™§ (è€ƒæ…®æ‰‹çºŒè²»)
  }

  // RRR (Spec 4)
  const rrr = slPct > 0 ? tpPct / slPct : 0;

  $('#sim-notional').textContent = notional.toFixed(2);
  $('#sim-size').textContent = size.toFixed(8); // æ”¯æ´æœ€å¤š 8 ä½å°æ•¸ (Spec 7)
  $('#sim-tp').textContent = tpPrice.toFixed(8);
  $('#sim-sl').textContent = slPrice.toFixed(8);
  $('#sim-pl').textContent = pl.toFixed(2);
  $('#sim-rrr').textContent = rrr.toFixed(2);

  updateRiskHint();
}

function updateRiskHint() {
  const capital = +$('#sim-capital').value || 0;
  const lev = +$('#sim-lev').value || 1;
  const entry = +$('#sim-entry-price').value || 0;
  const slPct = +$('#sim-sl-percent').value / 100 || 0;
  const side = $('#sim-side').value;
  const initBalance = parseFloat(retrieve('ut_initBalance') || 1000);

  if (capital <= 0 || lev <= 0 || entry <= 0 || slPct <= 0) {
    $('#risk-max-loss').value = '';
    $('#risk-liq-dist').value = '';
    $('#risk-level').value = '';
    return;
  }

  // æœ€å¤§è™§æ (ä»¥ SL è¨ˆç®—)
  const maxLoss = capital * lev * slPct;
  const riskPct = initBalance > 0 ? (maxLoss / initBalance) * 100 : 0;

  // çˆ†å€‰è·é›¢ (å‡è¨­å…¨å€‰ï¼Œä¸”ä¸è€ƒæ…®æ‰‹çºŒè²»)
  let liqPrice;
  if (side === 'å¤š') {
    liqPrice = entry * (1 - 1 / lev);
  } else {
    liqPrice = entry * (1 + 1 / lev);
  }
  const liqDistPct = Math.abs(entry - liqPrice) / entry * 100;

  let level = 'ä½';
  if (riskPct > 5) { level = 'é«˜'; }
  else if (riskPct > 2) { level = 'æ³¨æ„'; }

  $('#risk-max-loss').value = maxLoss.toFixed(2);
  $('#risk-liq-dist').value = liqDistPct.toFixed(2) + '%';
  $('#risk-level').value = level;
}

// å¯¦éš›ç´€éŒ„ RRR è¨ˆç®— (Spec 8)
function updateRecRRR() {
  const open = +$('#rec-open').value || 0;
  const tp = +$('#rec-tp').value || 0;
  const sl = +$('#rec-sl').value || 0;
  const side = $('#rec-side').value;
  const lev = +$('#rec-lev').value || 1;

  if (open <= 0 || tp <= 0 || sl <= 0 || lev <= 0) {
    $('#rec-rrr').value = '0.00';
    return;
  }

  let tpPct, slPct;
  if (side === 'å¤š') {
    tpPct = (tp - open) / open * lev;
    slPct = (open - sl) / open * lev;
  } else { // ç©º
    tpPct = (open - tp) / open * lev;
    slPct = (sl - open) / open * lev;
  }

  const rrr = slPct > 0 ? tpPct / slPct : 0;
  $('#rec-rrr').value = rrr.toFixed(2);
}

// å„€è¡¨æ¿é‚è¼¯ (Spec 5)
function filterByScope(records) {
  if (appState.dashboardScope === 'self') return records.filter(r => !r.isCopy);
  if (appState.dashboardScope === 'copy') return records.filter(r => r.isCopy);
  return records;
}

function updateBalance() {
  const init = parseFloat(retrieve('ut_initBalance') || 1000);
  const records = appState.records.filter(r => r.isClosed);
  const total = records.reduce((s, r) => s + (r.profit || 0), 0);
  const balance = init + total;
  $('#balanceDisplay').textContent = balance.toFixed(2);
  const input = $('#init-balance');
  input.value = init;
  input.onchange = () => { persist('ut_initBalance', input.value); updateBalance(); };
}

function calculateStrategyStats(filteredRecords) {
  const stats = {};
  const allStrategies = Object.keys(STRATEGY_TYPES);

  allStrategies.forEach(s => {
    stats[s] = { wins: 0, losses: 0, total: 0, rrrSum: 0, winRate: 0, avgRrr: 0 };
  });

  filteredRecords.forEach(r => {
    const s = r.strategy_type || 'S1';
    if (stats[s]) {
      if (r.result === 'ç›ˆ' || r.result === 'è™§') {
        stats[s].total++;
        stats[s].rrrSum += r.rrr;
        if (r.result === 'ç›ˆ') {
          stats[s].wins++;
        } else if (r.result === 'è™§') {
          stats[s].losses++;
        }
      }
    }
  });

  let bestStrategy = { type: 'N/A', winRate: -1, total: 0 };
  let worstStrategy = { type: 'N/A', winRate: 101, total: 0 };

  allStrategies.forEach(s => {
    const stat = stats[s];
    const counted = stat.wins + stat.losses;
    stat.winRate = counted > 0 ? (stat.wins / counted * 100) : 0;
    stat.avgRrr = counted > 0 ? stat.rrrSum / counted : 0; // RRR åªç®—æœ‰çµæœçš„å–®

    if (counted > 0) {
      if (stat.winRate > bestStrategy.winRate) {
        bestStrategy = { type: s, winRate: stat.winRate, total: counted };
      }
      if (stat.winRate < worstStrategy.winRate) {
        worstStrategy = { type: s, winRate: stat.winRate, total: counted };
      }
    }
  });

  return { stats, bestStrategy, worstStrategy };
}

function renderStrategyStats(stats, bestStrategy, worstStrategy) {
  const container = $('#strategy-kpis');
  if (!container) return;
  container.innerHTML = '';

  Object.keys(STRATEGY_TYPES).forEach(s => {
    const stat = stats[s];
    const title = STRATEGY_TYPES[s];
    const winRate = stat.winRate.toFixed(1);
    const avgRrr = stat.avgRrr.toFixed(2);
    const total = stat.wins + stat.losses;
    const isBest = bestStrategy.type === s && total > 0;
    const isWorst = worstStrategy.type === s && total > 0;

    const card = document.createElement('div');
    card.className = 'card';
    card.style.border = isBest ? '2px solid var(--accent)' : (isWorst ? '2px solid var(--danger)' : '1px solid var(--border)');
    card.innerHTML = `
      <div class="flex" style="justify-content:space-between">
        <span class="badge" style="background:${isBest ? 'var(--accent)' : (isWorst ? 'var(--danger)' : 'var(--border)')}; color:${isBest || isWorst ? '#fff' : 'var(--muted)'}">${s}</span>
        <small>${title.split('(')[0].trim()}</small>
      </div>
      <div style="margin-top:8px">
        <small>å‹ç‡</small>
        <div class="kpi" style="font-size:18px;color:${winRate >= 50 ? 'var(--accent)' : 'var(--danger)'}">${winRate}%</div>
      </div>
      <div class="hr" style="margin:4px 0"></div>
      <div class="flex" style="justify-content:space-between">
        <small>æ¬¡æ•¸: ${total}</small>
        <small>å¹³å‡ RRR: ${avgRrr}</small>
      </div>
    `;
    container.appendChild(card);
  });

  $('#best-strategy').textContent = bestStrategy.type;
  $('#best-strategy-winrate').textContent = bestStrategy.winRate.toFixed(1) + '%';
  $('#worst-strategy').textContent = worstStrategy.type;
  $('#worst-strategy-winrate').textContent = worstStrategy.winRate.toFixed(1) + '%';

  // Debug Panel æ›´æ–°
  if (DEBUG_MODE) {
    $('#debug-s1-winrate').textContent = stats['S1'].winRate.toFixed(1) + '%';
    $('#debug-s6-winrate').textContent = stats['S6'].winRate.toFixed(1) + '%';
  }
}

function updateDashboard() {
  const startDate = $('#filter-start-date').value;
  const endDate = $('#filter-end-date').value;
  let filtered = appState.records.filter(r => r.isClosed); // åªç¯©é¸å·²å¹³å€‰çš„ç´€éŒ„

  // æ—¥æœŸç¯©é¸ (Spec 9) - é‡å°å·²å¹³å€‰ç´€éŒ„ï¼Œæ‡‰ä½¿ç”¨ closeTime ç¯©é¸
  if (startDate) {
    const s = new Date(startDate);
    filtered = filtered.filter(r => r.closeTime && new Date(r.closeTime) >= s);
  }
  if (endDate) {
    // ä¿®æ­£æ—¥æœŸç¯©é¸é‚è¼¯ï¼šçµæŸæ—¥æœŸæ‡‰åŒ…å«ç•¶å¤©åˆå¤œ (23:59:59)
    const e = new Date(endDate);
    e.setDate(e.getDate() + 1); // å°‡æ—¥æœŸæ¨é€²åˆ°ä¸‹ä¸€å¤©çš„é›¶é»
    filtered = filtered.filter(r => r.closeTime && new Date(r.closeTime) < e);
  }

  const closedFiltered = filtered; // filtered ç¾åœ¨å·²ç¶“æ˜¯æ—¥æœŸç¯©é¸å¾Œçš„ closed records
  const scopeFiltered = filterByScope(closedFiltered);

  const total = scopeFiltered.length;
  const totalPl = scopeFiltered.reduce((a, r) => a + (isFinite(r.profit) ? r.profit : 0), 0);
  const wins = scopeFiltered.filter(r => r.result === 'ç›ˆ').length;
  const losses = scopeFiltered.filter(r => r.result === 'è™§').length;
  const counted = wins + losses;
  const winRate = counted > 0 ? (wins / counted * 100) : 0;
  const totalRrr = scopeFiltered.reduce((a, c) => a + (isFinite(c.rrr) ? c.rrr : 0), 0);
  const avgRrr = counted > 0 ? totalRrr / counted : 0; // RRR åªç®—æœ‰çµæœçš„å–®
  const maxWin = total ? Math.max(...scopeFiltered.map(r => r.profit || 0), 0) : 0;
  const maxLoss = total ? Math.min(...scopeFiltered.map(r => r.profit || 0), 0) : 0;

  $('#dash-total').textContent = total;
  $('#dash-pl').textContent = totalPl.toFixed(2);
  $('#dash-winrate').textContent = winRate.toFixed(1) + '%';
  $('#dash-rrr').textContent = avgRrr.toFixed(2);
  $('#dash-maxwin').textContent = maxWin.toFixed(2);
  $('#dash-maxloss').textContent = maxLoss.toFixed(2);

  // ç­–ç•¥ç¸¾æ•ˆ
  const { stats, bestStrategy, worstStrategy } = calculateStrategyStats(scopeFiltered);
  renderStrategyStats(stats, bestStrategy, worstStrategy);

  // Debug Panel æ›´æ–°
  if (DEBUG_MODE) {
    $('#debug-main-winrate').textContent = winRate.toFixed(1) + '%';
  }
}

// äº¤æ˜“ç´€éŒ„æ¸²æŸ“ (Spec 8)
function pad2(n) { return String(n).padStart(2, '0'); }
function monthKey(d) { const dt = new Date(d); return dt.getFullYear() + '-' + pad2(dt.getMonth() + 1); }
function monthTitleSlash(k) { const [y, m] = k.split('-'); return `${y} / ${m}`; }
function minutesBetween(a, b) { return Math.max(0, Math.round((new Date(b) - new Date(a)) / (1000 * 60))); }

// [æ–°åŠŸèƒ½] æŒå€‰æ™‚é–“æ ¼å¼åŒ–
function formatHoldTime(minutes) {
  if (minutes < 60) {
    return minutes + ' åˆ†';
  }
  
  // ç¸½åˆ†é˜æ•¸ >= 60
  const totalHours = minutes / 60;
  if (totalHours < 24) {
    const h = Math.floor(totalHours);
    const m = Math.round(minutes % 60);
    return h + ' æ™‚' + (m > 0 ? m + ' åˆ†' : '');
  }
  
  // ç¸½åˆ†é˜æ•¸ >= 1440 (24å°æ™‚)
  const d = Math.floor(minutes / 1440);
  const remainingMinutesAfterDays = minutes % 1440;
  const h = Math.floor(remainingMinutesAfterDays / 60);
  const m = Math.round(remainingMinutesAfterDays % 60);
  
  let result = d + ' æ—¥';
  if (h > 0) result += h + ' æ™‚';
  if (m > 0) result += m + ' åˆ†';
  
  return result;
}

function recordRow(r, index) {
  const tr = document.createElement('tr');
  const hasPl = (typeof r.profit === 'number' && isFinite(r.profit));
  const pnlColor = hasPl ? (r.profit > 0 ? 'var(--accent)' : (r.profit < 0 ? 'var(--danger)' : 'var(--muted)')) : 'var(--muted)';
  const plDisplay = hasPl ? r.profit.toFixed(2) : 'â€”';
  const rrrDisplay = (typeof r.rrr === 'number' && isFinite(r.rrr)) ? r.rrr.toFixed(2) : 'â€”';
  const typeLabel = r.isCopy ? 'è·Ÿå–®' : 'è‡ªå·±';
  const strategyLabel = r.strategy_type || 'N/A';
  const crossMonth = r.openTime && r.closeTime && (monthKey(r.openTime) !== monthKey(r.closeTime));
	  const holdMins = (r.openTime && r.closeTime) ? minutesBetween(r.openTime, r.closeTime) : 0;
	  const holdTimeDisplay = (r.openTime && r.closeTime) ? formatHoldTime(holdMins) : 'â€”';
	  const holdTimeClass = holdMins > 1440 ? 'style="font-size:11px"' : ''; // è¶…éä¸€å¤©ï¼Œå­—é«”ç¸®å°

	  tr.innerHTML = `
	    <td>${index}${crossMonth ? ' ğŸ“…' : ''}</td>
	    <td>${r.openTime ? new Date(r.openTime).toLocaleString() : 'â€”'}</td>
	    <td>${r.closeTime ? new Date(r.closeTime).toLocaleString() : 'â€”'}</td>
	    <td ${holdTimeClass}>${holdTimeDisplay}</td>
	    <td>${typeLabel}</td>
    <td>${r.symbol || ''}</td>
    <td>${r.capital || ''}</td>
    <td>${r.leverage || ''}</td>
    <td>${r.direction || ''}</td>
    <td>${strategyLabel}</td>
    <td>${r.timeframe || 'â€”'}</td>
    <td>${r.entry_price || ''}</td>
    <td>${r.tp || ''}</td>
    <td>${r.sl || ''}</td>
    <td>${rrrDisplay}</td>
    <td>${r.isClosed ? 'æ˜¯' : 'å¦'}</td>
    <td>${r.exit_price || 'â€”'}</td>
    <td style="color:${pnlColor}">${plDisplay}</td>
    <td>${r.feeRate || 'â€”'}</td>
    <td>${r.comment || 'â€”'}</td>
    <td class="flex"><button class="btn" data-edit="${r.id}">ä¿®æ”¹</button><button class="btn danger" data-del="${r.id}">åˆªé™¤</button></td>`;
  return tr;
}

function renderRecords() {
  const tbody = $('#tbl-records tbody');
  if (!tbody) return;
  tbody.innerHTML = '';
  let seq = 1;

  // æœªå¹³å€‰ç½®é ‚ (Spec 8.2)
  const openRecs = appState.records.filter(r => !r.isClosed).sort((a, b) => new Date(b.openTime || 0) - new Date(a.openTime || 0));
  const closedRecs = appState.records.filter(r => r.isClosed);

  if (openRecs.length) {
    const tr = document.createElement('tr');
    tr.className = 'section-toggle open';
    tr.innerHTML = `<td colspan="20" class="group-summary">ğŸ“˜ æœªå¹³å€‰ï¼ˆ${openRecs.length}ï¼‰</td>`;
    tbody.appendChild(tr);
    openRecs.forEach(r => tbody.appendChild(recordRow(r, seq++)));
  }

  // å·²å¹³å€‰ä¾æœˆä»½æŠ˜ç–Š (Spec 8.2)
  const groups = {};
  closedRecs.forEach(r => {
    const key = r.closeTime ? monthKey(r.closeTime) : (r.openTime ? monthKey(r.openTime) : 'æœªçŸ¥');
    (groups[key] = groups[key] || []).push(r);
  });
  const keys = Object.keys(groups).sort((a, b) => a < b ? 1 : -1);
  const now = new Date();
  const currentKey = now.getFullYear() + '-' + pad2(now.getMonth() + 1);

  keys.forEach(key => {
    const list = groups[key].sort((a, b) => new Date(b.closeTime || b.openTime || 0) - new Date(a.closeTime || b.openTime || 0));
    const isCurrent = (key === currentKey);
    const header = document.createElement('tr');
    header.className = 'section-toggle' + (isCurrent ? ' open' : '');
    header.dataset.monthKey = key;
    const arrow = isCurrent ? 'â–¾' : 'â–¸';
    const title = `<span class="arrow">${arrow}</span> ${monthTitleSlash(key)}ï¼ˆå·²å¹³å€‰ ${list.length} ç­†ï¼‰`;
    header.innerHTML = `<td colspan="20" class="group-summary">${title}</td>`;
    tbody.appendChild(header);

    list.forEach(r => {
      const row = recordRow(r, seq++);
      row.dataset.monthKey = key;
      if (!isCurrent) { row.style.display = 'none'; }
      tbody.appendChild(row);
    });
  });

  updateDashboard();
  updateBalance();
}

// TradingView å»ºç«‹ï¼ˆå®¹éŒ¯ + å»æŠ–ï¼‰
const tvState = { symbol: 'BINANCE:BTCUSDT', interval: '60' };
const createTVWidget = (function() {
  let timer = null;
  return function() {
    clearTimeout(timer);
    timer = setTimeout(() => {
      try {
        if (window.TradingView && TradingView.widget) {
          if (appState.tvWidget) {
            try { appState.tvWidget.remove(); } catch (_e) {}
            appState.tvWidget = null;
          }
          const theme = (document.documentElement.dataset.theme === 'dark') ? 'dark' : 'light';
          const watchlist = retrieve('tv_watchlist') || ["BINANCE:BTCUSDT", "BINANCE:ETHUSDT", "BINANCE:SOLUSDT", "BINANCE:BNBUSDT", "BINANCE:ADAUSDT"];
          appState.tvWidget = new TradingView.widget({
            container_id: 'tv-container',
            symbol: tvState.symbol,
            interval: tvState.interval,
            timezone: 'Asia/Taipei',
            theme,
            style: '1',
            locale: 'zh_TW',
            autosize: true,
            height: 560,
            toolbar_bg: theme === 'light' ? '#f1f3f6' : '#161c28',
            enable_publishing: false,
            allow_symbol_change: true,
            studies: (retrieve('ut_studies') || []),
            show_popup_button: true,
            popup_width: '1000',
            popup_height: '650',
            watchlist,
            details: true,
            hotlist: true,
            calendar: true,
            hide_side_toolbar: false,
            save_image: false,
            withdateranges: true,
            range: '1M'
          });
        } else {
          console.warn("TradingView not loaded yet, retrying...");
          setTimeout(() => {
            if (window.TradingView && TradingView.widget) initApp();
          }, 3000);
        }
      } catch (e) {
        console.error("TV load error:", e);
      }
    }, 200);
  };
})();

// é‡åŒ–æ±ºç­–é‚è¼¯ (Spec 9)
function formatCombo(d) {
  const parts = [];
  if (d.pattern === 'æ˜¯') parts.push('ç†Ÿæ‚‰å½¢æ…‹');
  if (d.market === 'æ˜¯') parts.push('è·Ÿå¤§ç›¤');
  if (d.drawLine === 'æ˜¯') parts.push('ç•«ç·š');
  if (d.kline_types && d.kline_types.length) parts.push(`Kç·š(${d.kline_types.join(',')})`);
  // [ä¿®æ”¹ 4] åœ¨å…±æŒ¯çµ„åˆé¡¯ç¤ºä¸­åŠ å…¥å‡ç·š
  if (d.ma === 'é †å‹¢' || d.ma === 'é€†å‹¢') parts.push('å‡ç·š');
  return parts.join(' + ');
}

function calculateQuantWinRate(decisions) {
  const filtered = decisions.filter(d => d.enter === 'æ˜¯' && (d.result === 'å‹' || d.result === 'æ•—'));
  const wins = filtered.filter(d => d.result === 'å‹').length;
  const losses = filtered.filter(d => d.result === 'æ•—').length;
  const total = wins + losses;
  return total > 0 ? (wins / total * 100) : 0;
}

function calculateResonanceScore(d) {
  let score = 0;
  // å½¢æ…‹ (ç†Ÿæ‚‰å½¢æ…‹)
  if (d.pattern === 'æ˜¯') score += 1;
  // è¶¨å‹¢ (ä¸Šè¡Œ/ä¸‹è¡Œ)
  if (d.trend === 'ä¸Šè¡Œ' || d.trend === 'ä¸‹è¡Œ') score += 1;
  // å¤§ç›¤ (è·Ÿå¤§ç›¤)
  if (d.market === 'æ˜¯') score += 1;
  // ç•«ç·š
  if (d.drawLine === 'æ˜¯') score += 1;
  // çªç ´
  if (d.breakout !== 'å¦') score += 1;
  // Kç·š
  if (d.kline_types && d.kline_types.length > 0) score += 1;
  // [ä¿®æ”¹ 4] åŠ å…¥å‡ç·šå› å­ï¼šè‹¥æœ‰åƒè€ƒå‡ç·šï¼ˆé †å‹¢/é€†å‹¢ï¼‰ï¼Œå‰‡å…±æŒ¯åˆ†æ•¸ +1
  if (d.ma === 'é †å‹¢' || d.ma === 'é€†å‹¢') score += 1;
  return score;
}

function calcTopCombos() {
  const grouped = {};
  appState.decisions.forEach(d => {
    if (d.enter === 'æ˜¯' && (d.result === 'å‹' || d.result === 'æ•—')) {
      const key = formatCombo(d);
      if (!key) return;
      if (!grouped[key]) grouped[key] = { wins: 0, total: 0, rrrSum: 0 };
      if (d.result === 'å‹') grouped[key].wins++;
      grouped[key].total++;
      grouped[key].rrrSum += (+d.rrr || 0);
    }
  });
  return Object.entries(grouped).map(([combo, v]) => ({
    combo,
    winrate: v.total ? (v.wins / v.total * 100) : 0,
    avgRrr: v.total ? (v.rrrSum / v.total) : 0,
    total: v.total
  })).sort((a, b) => b.winrate - a.winrate).slice(0, 3);
}

function renderTopCombos() {
  const combos = calcTopCombos();
  const ul = $('#comboList');
  if (!ul) return;
  if (!combos.length) {
    ul.innerHTML = '<li class="note">è³‡æ–™ä¸è¶³</li>';
    return;
  }
  ul.innerHTML = combos.map(c => {
    const color = c.winrate >= 60 ? 'var(--accent)' : (c.winrate >= 50 ? '#f97316' : 'var(--danger)');
    return `<li style="margin-bottom:8px">
      <div class="flex" style="justify-content:space-between"><small style="font-weight:700">${c.combo}</small><small>æ¨£æœ¬ ${c.total} Â· å¹³å‡ R ${c.avgRrr.toFixed(2)}</small></div>
      <div class="kpi-bar-wrap" style="margin-top:4px"><div class="kpi-bar" style="background:${color};width:${c.winrate}%;"></div></div>
      <div style="font-size:12px;color:${color};font-weight:700">${c.winrate.toFixed(1)}% å‹ç‡</div>
    </li>`;
  }).join('');
}

function renderQuantTable() {
  const tbody = $('#tbl-quant tbody');
  if (!tbody) return;
  tbody.innerHTML = '';
  const resultOptions = ['æœªåŸ·è¡Œ', 'å‹', 'æ•—', 'å…¶ä»–'];
  appState.decisions.forEach((d, i) => {
    const tr = document.createElement('tr');
    const resultSel = `<select class="input quant-result" data-qid="${d.id}">
      ${resultOptions.map(o => `<option value="${o}" ${d.result === o ? 'selected' : ''}>${o}</option>`).join('')}
    </select>`;
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${d.symbol}</td>
      <td>${d.pattern}</td>
      <td>${d.trend}</td>
      <td>${d.market}</td>
      <td>${(d.kline_types || []).join('|') || 'â€”'}</td>
      <td>${d.ma || 'æœªåƒè€ƒ'}</td>
      <td>${d.breakout || 'å¦'}</td>
      <td>${d.drawLine || 'å¦'}</td>
      <td>${(+d.rrr || 0).toFixed(2)}</td>
      <td>${d.enter}</td>
      <td>${resultSel}</td>
      <td>${d.comment || ''}</td>
      <td class="flex"><button class="btn danger" data-qdel="${d.id}">åˆªé™¤</button></td>`;
    tbody.appendChild(tr);
  });

  // ç¶å®šäº‹ä»¶
  tbody.querySelectorAll('[data-qdel]').forEach(b => b.addEventListener('click', () => {
    const id = b.dataset.qdel;
    const idx = appState.decisions.findIndex(x => x.id === id);
    if (idx >= 0) {
      appState.decisions.splice(idx, 1);
      persist('ut_decisions', appState.decisions);
      renderQuantTable();
      renderTopCombos();
      if (DEBUG_MODE) updateDebugPanel();
    }
  }));
  tbody.addEventListener('change', (e) => {
    const sel = e.target.closest('.quant-result');
    if (!sel) return;
    const id = sel.dataset.qid;
    const d = appState.decisions.find(x => x.id === id);
    if (d) {
      d.result = sel.value;
      persist('ut_decisions', appState.decisions);
      renderTopCombos();
      if (DEBUG_MODE) updateDebugPanel();
    }
  });
}

// Debug æ¨¡å¼ç›¸é—œ (Spec 11)
function createTestData() {
  const now = new Date().toISOString();
  const testRecords = [{
    id: 'test-rec-1', symbol: 'BTCUSDT', direction: 'å¤š', strategy_type: 'S1', entry_price: 30000, exit_price: 30300, leverage: 10, capital: 100, rrr: 3.0, profit: 90, isCopy: false, isClosed: true, openTime: now, closeTime: now, comment: 'S1 æ¸¬è©¦ç›ˆ', timeframe: '1h', feeRate: 0.05, result: 'ç›ˆ', closed: 'æ˜¯', open: 30000, close: 30300, pl: 90, fee: 0.5, reason: 'S1 æ¸¬è©¦ç›ˆ', side: 'å¤š', lev: 10, invest: 100, tp: 30300, sl: 29900, quantEnter: 'æ˜¯'
  }, {
    id: 'test-rec-2', symbol: 'ETHUSDT', direction: 'ç©º', strategy_type: 'S1', entry_price: 2000, exit_price: 2020, leverage: 5, capital: 200, rrr: 1.0, profit: -20, isCopy: false, isClosed: true, openTime: now, closeTime: now, comment: 'S1 æ¸¬è©¦è™§', timeframe: '4h', feeRate: 0.05, result: 'è™§', closed: 'æ˜¯', open: 2000, close: 2020, pl: -20, fee: 1, reason: 'S1 æ¸¬è©¦è™§', side: 'ç©º', lev: 5, invest: 200, tp: 1980, sl: 2020, quantEnter: 'æ˜¯'
  }, {
    id: 'test-rec-3', symbol: 'SOLUSDT', direction: 'å¤š', strategy_type: 'S6', entry_price: 100, exit_price: 105, leverage: 20, capital: 50, rrr: 5.0, profit: 200, isCopy: true, isClosed: true, openTime: now, closeTime: now, comment: 'S6 æ¸¬è©¦ç›ˆ', timeframe: '15m', feeRate: 0.05, result: 'ç›ˆ', closed: 'æ˜¯', open: 100, close: 105, pl: 200, fee: 0.5, reason: 'S6 æ¸¬è©¦ç›ˆ', side: 'å¤š', lev: 20, invest: 50, tp: 105, sl: 99.5, quantEnter: 'æ˜¯'
  }, {
    id: 'test-rec-4', symbol: 'BNBUSDT', direction: 'ç©º', strategy_type: 'S6', entry_price: 300, exit_price: 305, leverage: 5, capital: 100, rrr: 1.0, profit: -20, isCopy: false, isClosed: true, openTime: now, closeTime: now, comment: 'S6 æ¸¬è©¦è™§', timeframe: '1h', feeRate: 0.05, result: 'è™§', closed: 'æ˜¯', open: 300, close: 305, pl: -20, fee: 0.5, reason: 'S6 æ¸¬è©¦è™§', side: 'ç©º', lev: 5, invest: 100, tp: 295, sl: 305, quantEnter: 'æ˜¯'
  }, {
    id: 'test-rec-5', symbol: 'XRPUSDT', direction: 'å¤š', strategy_type: 'S3', entry_price: 0.5, exit_price: 0, leverage: 10, capital: 50, rrr: 0, profit: 0, isCopy: false, isClosed: false, openTime: now, closeTime: null, comment: 'æœªå¹³å€‰', timeframe: '1h', feeRate: 0.05, result: 'å¹³', closed: 'å¦', open: 0.5, close: 0, pl: 0, fee: 0, reason: 'æœªå¹³å€‰', side: 'å¤š', lev: 10, invest: 50, tp: 0.55, sl: 0.45, quantEnter: 'å¦'
  }];

  const testDecisions = [{
    id: 'test-dec-1', symbol: 'BTCUSDT', pattern: 'æ˜¯', trend: 'ä¸Šè¡Œ', market: 'æ˜¯', breakout: 'æ¿€é€²', drawLine: 'æ˜¯', isHot: 'æ˜¯', kline_types: ['åå™¬', 'éŒ˜å­'], ma: 'é †å‹¢', volume: 'æ˜¯', enter: 'æ˜¯', result: 'å‹', rrr: 3.0, comment: 'æ¸¬è©¦å…±æŒ¯å‹', time: now
  }, {
    id: 'test-dec-2', symbol: 'ETHUSDT', pattern: 'å¦', trend: 'ä¸‹è¡Œ', market: 'å¦', breakout: 'ä¿å®ˆ', drawLine: 'å¦', isHot: 'å¦', kline_types: ['æµæ˜Ÿ'], ma: 'é€†å‹¢', volume: 'å¦', enter: 'æ˜¯', result: 'æ•—', rrr: 1.0, comment: 'æ¸¬è©¦å…±æŒ¯æ•—', time: now
  }, {
    id: 'test-dec-3', symbol: 'SOLUSDT', pattern: 'æ˜¯', trend: 'ä¸Šè¡Œ', market: 'æ˜¯', breakout: 'æ¿€é€²', drawLine: 'æ˜¯', isHot: 'æ˜¯', kline_types: ['åå™¬'], ma: 'é †å‹¢', volume: 'æ˜¯', enter: 'æ˜¯', result: 'å‹', rrr: 5.0, comment: 'æ¸¬è©¦å…±æŒ¯å‹', time: now
  }, {
    id: 'test-dec-4', symbol: 'BNBUSDT', pattern: 'å¦', trend: 'ç›¤æ•´', market: 'æ˜¯', breakout: 'å¦', drawLine: 'æ˜¯', isHot: 'å¦', kline_types: [], ma: 'æœªåƒè€ƒ', volume: 'æ˜¯', enter: 'å¦', result: 'æœªåŸ·è¡Œ', rrr: 1.5, comment: 'æœªé€²å ´', time: now
  }, {
    id: 'test-dec-5', symbol: 'XRPUSDT', pattern: 'æ˜¯', trend: 'ä¸Šè¡Œ', market: 'æ˜¯', breakout: 'æ¿€é€²', drawLine: 'æ˜¯', isHot: 'æ˜¯', kline_types: ['åå™¬', 'éŒ˜å­'], ma: 'é †å‹¢', volume: 'æ˜¯', enter: 'æ˜¯', result: 'æœªåŸ·è¡Œ', rrr: 2.0, comment: 'æœªåŸ·è¡Œ', time: now
  }];

  persist('ut_records', testRecords);
  persist('ut_decisions', testDecisions);
  appState.records = normalizeRecords(testRecords);
  appState.decisions = testDecisions;
}

function updateDebugPanel() {
  if (!DEBUG_MODE) return;
  $('#debug-panel').style.display = 'block';
  $('#debug-records-count').textContent = appState.records.length;
  $('#debug-decisions-count').textContent = appState.decisions.length;
  // ä¸»å‹ç‡å·²åœ¨ updateDashboard ä¸­æ›´æ–°
  $('#debug-main-winrate').textContent = $('#dash-winrate').textContent;
  $('#debug-cloud-sync').textContent = appState.isCloudEnabled ? 'Enabled' : 'Disabled';
  $('#debug-cloud-sync').style.color = appState.isCloudEnabled ? 'var(--accent)' : 'var(--danger)';
}

// åŒ¯å‡º CSV é‚è¼¯ (Spec 9)
function exportRecordsCSV() {
  const records = appState.records;
  const headers = ['id', 'symbol', 'direction', 'strategy_type', 'setup_description', 'entry_price', 'exit_price', 'leverage', 'capital', 'rrr', 'profit', 'isCopy', 'isClosed', 'openTime', 'closeTime', 'comment', 'timeframe', 'feeRate'];
  const rows = [headers].concat(records.map(r => [
    r.id, r.symbol, r.direction, r.strategy_type, r.comment, r.entry_price, r.exit_price, r.leverage, r.capital, r.rrr, r.profit, r.isCopy ? 'è·Ÿå–®' : 'è‡ªå·±', r.isClosed ? 'æ˜¯' : 'å¦', r.openTime, r.closeTime, r.comment, r.timeframe, r.feeRate
  ]));

  const csv = rows.map(r => r.map(x => `"${String(x).replaceAll('"', '""')}"`).join(',')).join('\n');
  const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' }); // UTF-8 BOM
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'u_trader_records.csv';
  a.click();
  URL.revokeObjectURL(url);
  toast('äº¤æ˜“ç´€éŒ„å·²åŒ¯å‡º');
}

function exportQuantCSV() {
  const decisions = appState.decisions;
  const headers = ['id', 'symbol', 'pattern', 'trend', 'market', 'breakout', 'drawLine', 'isHot', 'kline_types', 'ma', 'volume', 'enter', 'result', 'rrr', 'comment', 'time'];
  const rows = [headers].concat(decisions.map(d => [
    d.id, d.symbol, d.pattern, d.trend, d.market, d.breakout, d.drawLine, d.isHot, (d.kline_types || []).join('|'), d.ma, d.volume, d.enter, d.result, d.rrr, d.comment, d.time
  ]));

  const csv = rows.map(r => r.map(x => `"${String(x).replaceAll('"', '""')}"`).join(',')).join('\n');
  const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' }); // UTF-8 BOM
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'u_trader_quant.csv';
  a.click();
  URL.revokeObjectURL(url);
  toast('é‡åŒ–æ±ºç­–å·²åŒ¯å‡º');
}

// Supabase é‚è¼¯ (æ¡†æ¶)
const debounce = (func, delay) => {
  let timeoutId;
  return (...args) => {
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => {
      func.apply(this, args);
    }, delay);
  };
};

const syncToSupabase = debounce(async (key, data) => {
  if (!appState.supabaseClient || !appState.userId) return;
  try {
    const { error } = await appState.supabaseClient
      .from('user_data')
      .update({ [key]: data, updated_at: new Date().toISOString() })
      .eq('user_id', appState.userId);
    if (error) throw error;
    console.log(`Successfully synced ${key} to cloud.`);
  } catch (error) {
    console.error('Error syncing to Supabase:', error.message);
    toast(`é›²ç«¯åŒæ­¥å¤±æ•—: ${error.message}`);
  }
}, 1500);

async function syncWithCloud() {
  if (!appState.supabaseClient) {
    toast('Supabase å®¢æˆ¶ç«¯æœªåˆå§‹åŒ–');
    return false;
  }

  try {
    let { data: { user } } = await appState.supabaseClient.auth.getUser();
    if (!user) {
        const { data: sessionData, error: sessionError } = await appState.supabaseClient.auth.signInAnonymously();
        if (sessionError) throw sessionError;
        if (!sessionData.user) throw new Error('Anonymous sign-in failed.');
        user = sessionData.user;
    }
    appState.userId = user.id;

    let { data, error } = await appState.supabaseClient
      .from('user_data')
      .select('ut_records, ut_decisions, ut_initBalance')
      .eq('user_id', appState.userId)
      .single();

    if (error && error.code === 'PGRST116') {
      const localRecords = retrieve('ut_records') || [];
      const localDecisions = retrieve('ut_decisions') || [];
      const localBalance = retrieve('ut_initBalance') || 1000;

      const { data: newUserData, error: insertError } = await appState.supabaseClient
        .from('user_data')
        .insert({ 
          user_id: appState.userId, 
          ut_records: localRecords, 
          ut_decisions: localDecisions, 
          ut_initBalance: localBalance 
        })
        .select('ut_records, ut_decisions, ut_initBalance')
        .single();
      if (insertError) throw insertError;
      data = newUserData;
      toast('é¦–æ¬¡é›²ç«¯åŒæ­¥ï¼šå·²å°‡æœ¬æ©Ÿè³‡æ–™ä¸Šå‚³è‡³é›²ç«¯');
    } else if (error) {
      throw error;
    }

    if (data) {
      appState.records = normalizeRecords(data.ut_records || []);
      appState.decisions = data.ut_decisions || [];
      persist('ut_records', appState.records);
      persist('ut_decisions', appState.decisions);
      persist('ut_initBalance', data.ut_initBalance || '1000');
      toast('å·²å¾é›²ç«¯åŒæ­¥è³‡æ–™');
      return true;
    }
    return false;
  } catch (error) {
    console.error('Error syncing with cloud:', error.message);
    toast(`é›²ç«¯åŒæ­¥å¤±æ•—: ${error.message}`);
    return false;
  }
}

function initSupabase() {
  const cloudConfig = retrieve('ut_cloud');
  if (cloudConfig && cloudConfig.enabled && cloudConfig.url && cloudConfig.key) {
    try {
      appState.supabaseClient = supabase.createClient(cloudConfig.url, cloudConfig.key);
      appState.isCloudEnabled = true;
      $('#btn-enable-cloud').style.display = 'none';
      $('#btn-disable-cloud').style.display = 'inline-flex';
      toast('é›²ç«¯åŒæ­¥å·²å•Ÿç”¨');
    } catch (e) {
      console.error("Supabase init error:", e);
      appState.isCloudEnabled = false;
      toast('Supabase åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨­å®š', 3000);
    }
  } else {
    appState.isCloudEnabled = false;
    $('#btn-enable-cloud').style.display = 'inline-flex';
    $('#btn-disable-cloud').style.display = 'none';
  }
  if (DEBUG_MODE) updateDebugPanel();
}

async function enableCloud() {
  const url = $('#sb-url').value.trim();
  const key = $('#sb-key').value.trim();
  if (!url || !key) {
    toast('URL å’Œ Key å¿…å¡«', 2000);
    return;
  }
  const config = { url, key, enabled: true };
  persist('ut_cloud', config);
  
  try {
    appState.supabaseClient = supabase.createClient(url, key);
    toast('æ­£åœ¨å˜—è©¦åŒæ­¥...');
    const success = await syncWithCloud();

    if (success) {
      appState.isCloudEnabled = true;
      $('#sb-url').value = url;
      $('#sb-key').value = key;
      $('#btn-enable-cloud').style.display = 'none';
      $('#btn-disable-cloud').style.display = 'inline-flex';
      toast('é›²ç«¯åŒæ­¥å·²å•Ÿç”¨');
      renderRecords();
      updateDashboard();
    } else {
      appState.supabaseClient = null;
      appState.isCloudEnabled = false;
      persist('ut_cloud', { url, key, enabled: false });
      throw new Error('ç„¡æ³•é€£æ¥åˆ°é›²ç«¯æˆ–åŒæ­¥è³‡æ–™å¤±æ•—');
    }
  } catch (e) {
    console.error('Enable cloud failed:', e);
    toast(`å•Ÿç”¨å¤±æ•—: ${e.message}`);
    appState.isCloudEnabled = false;
    appState.supabaseClient = null;
    persist('ut_cloud', { url, key, enabled: false });
    $('#btn-enable-cloud').style.display = 'inline-flex';
    $('#btn-disable-cloud').style.display = 'none';
  }
  if (DEBUG_MODE) updateDebugPanel();
}

function disableCloud() {
  const config = retrieve('ut_cloud') || {};
  config.enabled = false;
  persist('ut_cloud', config);
  appState.isCloudEnabled = false;
  appState.supabaseClient = null;
  appState.userId = null;
  $('#btn-enable-cloud').style.display = 'inline-flex';
  $('#btn-disable-cloud').style.display = 'none';
  toast('é›²ç«¯åŒæ­¥å·²åœç”¨');
  if (DEBUG_MODE) updateDebugPanel();
}

// ====== åˆå§‹åŒ– ======
function initApp() {
  try {
    // 1. Debug Mode
    if (DEBUG_MODE) {
      createTestData();
      updateDebugPanel();
    }

    // 2. ä¸»é¡Œ
    const savedTheme = localStorage.getItem('ut_theme') || 'light';
    if (savedTheme === 'dark') document.documentElement.dataset.theme = 'dark';
    else document.documentElement.removeAttribute('data-theme');

    // 3. è³‡æ–™
    appState.records = normalizeRecords(retrieve('ut_records') || []);
    appState.decisions = retrieve('ut_decisions') || [];
    appState.cloud = retrieve('ut_cloud');
    appState.studies = retrieve('ut_studies') || [];

    // 3.5. é›²ç«¯åˆå§‹åŒ–
    initSupabase();

    // 4. Tabs
    $$('.tab').forEach(t => t.addEventListener('click', () => {
      $$('.tab').forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      document.querySelectorAll('section').forEach(s => s.style.display = 'none');
      document.getElementById(t.dataset.page).style.display = 'block';
      if (t.dataset.page === 'p-market') createTVWidget();
      if (t.dataset.page === 'p-sim') recalcSim();
      if (t.dataset.page === 'p-records') updateRecRRR();
    }));

    // 5. å„€è¡¨æ¿äº‹ä»¶
    $('#scopeSeg') && $('#scopeSeg').addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      $$('#scopeSeg button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      appState.dashboardScope = btn.dataset.scope;
      updateDashboard();
    });
    safeBind("btn-rerun-stats", "click", updateDashboard);
    safeBind("filter-start-date", "change", updateDashboard);
    safeBind("filter-end-date", "change", updateDashboard);

    // 6. é¡è‰²ä¸»é¡Œ
    safeBind("lightBtn", "click", () => {
      document.documentElement.removeAttribute('data-theme');
      localStorage.setItem('ut_theme', 'light');
      createTVWidget();
    });
    safeBind("darkBtn", "click", () => {
      document.documentElement.dataset.theme = 'dark';
      localStorage.setItem('ut_theme', 'dark');
      createTVWidget();
    });

    // 7. TV ç›¸é—œ
    if ($('#tv-symbol')) tvState.symbol = $('#tv-symbol').value;
    if ($('#tv-interval')) tvState.interval = $('#tv-interval').value;
    safeBind("tv-apply", "click", () => {
      tvState.symbol = $('#tv-symbol').value.toUpperCase();
      tvState.interval = $('#tv-interval').value;
      createTVWidget();
    });
    document.querySelectorAll('[data-preset]').forEach(b => b.addEventListener('click', () => {
      $('#tv-symbol').value = b.dataset.preset;
      tvState.symbol = b.dataset.preset;
      createTVWidget();
    }));

    // è§€å¯Ÿæ¸…å–®
    function rebuildPills(list) {
      const holder = $('#watch-pills');
      if (!holder) return;
      holder.innerHTML = '';
      list.forEach(sym => {
        const sp = document.createElement('span');
        sp.className = 'pill';
        sp.textContent = sym;
        sp.addEventListener('click', () => {
          $('#tv-symbol').value = sym;
          tvState.symbol = sym;
          createTVWidget();
        });
        holder.appendChild(sp);
      });
    }
    safeBind("btn-apply-watch", "click", () => {
      const raw = $('#watchlist') ? $('#watchlist').value : '';
      const parts = (raw || '').split(/\s+|\n+/).map(s => s.trim().toUpperCase()).filter(Boolean);
      let wl = retrieve('tv_watchlist') || ["BINANCE:BTCUSDT", "BINANCE:ETHUSDT", "BINANCE:SOLUSDT", "BINANCE:BNBUSDT", "BINANCE:ADAUSDT"];
      parts.forEach(p => {
        if (!wl.includes(p)) wl.push(p);
      });
      persist('tv_watchlist', wl);
      rebuildPills(wl);
      toast('å·²ç”Ÿæˆè§€å¯Ÿæ¸…å–®æ¨™ç±¤', 1500);
    });
    rebuildPills(retrieve('tv_watchlist') || ["BINANCE:BTCUSDT", "BINANCE:ETHUSDT", "BINANCE:SOLUSDT", "BINANCE:BNBUSDT", "BINANCE:ADAUSDT"]);

    // æŒ‡æ¨™å‹¾é¸
    if ($('#indicatorToggles')) {
      $('#indicatorToggles').querySelectorAll('input[type="checkbox"]').forEach(chk => {
        chk.checked = (appState.studies || []).includes(chk.dataset.study);
      });
      safeBind("btn-apply-studies", "click", () => {
        const studies = Array.from($('#indicatorToggles').querySelectorAll('input[type="checkbox"]:checked')).map(chk => chk.dataset.study);
        appState.studies = studies;
        persist('ut_studies', studies);
        createTVWidget();
        toast('å·²å¥—ç”¨æŒ‡æ¨™');
      });
    }

    // 8. æ¨¡æ“¬è©¦ç®—
    ['sim-entry-price', 'sim-side', 'sim-tp-percent', 'sim-sl-percent', 'sim-capital', 'sim-lev', 'sim-fee'].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('input', recalcSim);
      }
    });
    safeBind("btn-to-record", "click", () => {
      if (!$('#rec-asset')) return;
      $('#rec-asset').value = $('#sim-asset').value;
      $('#rec-invest').value = $('#sim-capital').value;
      $('#rec-lev').value = $('#sim-lev').value;
      $('#rec-side').value = $('#sim-side').value;
      $('#rec-open').value = $('#sim-entry-price').value;
      $('#rec-tp').value = $('#sim-tp').textContent;
      $('#rec-sl').value = $('#sim-sl').textContent;
      $('#rec-fee').value = $('#sim-fee').value;
      updateRecRRR();
      const tabBtn = document.querySelector('[data-page="p-records"]');
      if (tabBtn) tabBtn.click();
      toast('å·²å¸¶å…¥ç´€éŒ„è¡¨å–®', 1500);
    });
    recalcSim();

    // 9. å¯¦éš›ç´€éŒ„ï¼šRRR èˆ‡ Â± å¿«æ·
    ['rec-invest', 'rec-lev', 'rec-side', 'rec-open', 'rec-tp', 'rec-sl'].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('input', updateRecRRR);
      }
    });
    safeBind("pl-minus", "click", () => {
      const v = parseFloat($('#rec-pl').value) || 0;
      $('#rec-pl').value = -Math.abs(v);
    });
    safeBind("pl-plus", "click", () => {
      const v = parseFloat($('#rec-pl').value) || 0;
      $('#rec-pl').value = Math.abs(v);
    });

    // æ–°å¢/æ›´æ–°ç´€éŒ„
    safeBind("btn-add-record", "click", () => {
      const strategyType = $('#rec-strategy-type').value;
      if (!strategyType) {
        toast('è«‹é¸æ“‡ç­–ç•¥åˆ†é¡ (Strategy Type)', 2000);
        return;
      }

      const asset = $('#rec-asset').value.trim().toUpperCase();
      const invest = +$('#rec-invest').value || 0;
      const lev = +$('#rec-lev').value || 1;
      const side = $('#rec-side').value;
      const open = +$('#rec-open').value || 0;
      const tp = +$('#rec-tp').value || 0;
      const sl = +$('#rec-sl').value || 0;
      const fee = +$('#rec-fee').value || 0;
      const closed = $('#rec-closed').value;
      const close = +$('#rec-close').value || 0;
      const pl = parseFloat($('#rec-pl').value) || 0;
      const timeframe = $('#rec-timeframe').value;
      const isCopy = $('#rec-iscopy').value === 'true';
      const rrr = +($('#rec-rrr').value) || 0;
      const quantEnter = $('#rec-quant-enter').value;
      const reason = $('#rec-reason').value || '';
      const nowIso = new Date().toISOString();
      let openTimeIso, closeTimeIso;
      let id = currentEditId || (Date.now().toString(36) + Math.random().toString(36).slice(2));

      if (currentEditId) {
        const prev = appState.records.find(x => x.id === currentEditId) || {};
        openTimeIso = prev.openTime || nowIso;
        if (closed === 'æ˜¯') {
          closeTimeIso = prev.closeTime || new Date().toISOString();
        } else {
          closeTimeIso = null;
        }
      } else {
        openTimeIso = nowIso;
        closeTimeIso = (closed === 'æ˜¯') ? nowIso : null;
      }
      const isClosed = closed === 'æ˜¯';
      const result = pl > 0 ? 'ç›ˆ' : (pl < 0 ? 'è™§' : 'å¹³');

      const item = {
        id,
        symbol: asset,
        direction: side,
        strategy_type: strategyType,
        setup_description: reason,
        entry_price: open,
        exit_price: close,
        leverage: lev,
        capital: invest,
        rrr: rrr,
        profit: pl,
        isCopy: isCopy,
        isClosed: isClosed,
        openTime: openTimeIso,
        closeTime: closeTimeIso,
        comment: reason,
        timeframe: timeframe,
        feeRate: fee,
        // èˆŠç‰ˆç›¸å®¹æ¬„ä½ (ç”¨æ–¼ UI ç¶å®š)
        asset, side, lev, open, tp, sl, closed: closed === 'æ˜¯' ? 'æ˜¯' : 'å¦', close, pl, fee, reason, result, quantEnter, invest
      };

      if (currentEditId) {
        const idx = appState.records.findIndex(x => x.id === currentEditId);
        if (idx >= 0) appState.records[idx] = item;
        else appState.records.unshift(item);
      } else appState.records.unshift(item);

      currentEditId = null;
      appState.records = normalizeRecords(appState.records);
      persist('ut_records', appState.records);

      // æ¸…ç©ºè¡¨å–®
      $('#rec-asset').value = 'BTCUSDT';
      $('#rec-invest').value = '100';
      $('#rec-lev').value = '10';
      $('#rec-side').value = 'å¤š';
      $('#rec-strategy-type').value = '';
      $('#rec-timeframe').value = '1h';
      $('#rec-open').value = '30000';
      $('#rec-tp').value = '30450';
      $('#rec-sl').value = '29850';
      $('#rec-closed').value = 'å¦';
      $('#rec-close').value = '0';
      $('#rec-pl').value = '0';
      $('#rec-fee').value = '0';
      $('#rec-reason').value = '';
      $('#rec-open-time').value = '';
      $('#rec-close-time').value = '';
      updateRecRRR();

      renderRecords();
      updateDashboard();
      if (DEBUG_MODE) updateDebugPanel();
      toast('äº¤æ˜“ç´€éŒ„å·²å„²å­˜');
    });

    // æ¸…ç©ºç´€éŒ„
    safeBind("btn-clear-records", "click", () => {
      if (confirm('ç¢ºå®šæ¸…ç©ºæœ¬æ©Ÿæ‰€æœ‰ç´€éŒ„ï¼Ÿ')) {
        appState.records = [];
        currentEditId = null;
        persist('ut_records', appState.records);
        renderRecords();
        updateDashboard();
        if (DEBUG_MODE) updateDebugPanel();
        toast('æœ¬æ©Ÿç´€éŒ„å·²æ¸…ç©º');
      }
    });

    // åŒ¯å‡ºç´€éŒ„
    safeBind("btn-export-records", "click", exportRecordsCSV);

    // åˆ—è¡¨é»æ“Šï¼ˆä¿®æ”¹/åˆªé™¤ + æ‘ºç–Šï¼‰
    const tbl = $('#tbl-records');
    if (tbl) {
      tbl.addEventListener('click', (e) => {
        const tbody = $('#tbl-records tbody');

        const monthHeader = e.target.closest('tr.section-toggle');
        if (monthHeader && monthHeader.dataset.monthKey) {
          const key = monthHeader.dataset.monthKey;
          const isOpen = monthHeader.classList.contains('open');
          monthHeader.classList.toggle('open', !isOpen);
          const rows = tbody ? tbody.querySelectorAll(`tr[data-month-key="${key}"]`) : [];
          rows.forEach(row => {
            // åªæœ‰äº¤æ˜“ç´€éŒ„è¡Œæ‰é€²è¡Œéš±è—/é¡¯ç¤ºï¼Œæœˆä»½æ¨™é¡Œè¡Œ (monthHeader) ä¸å‹•
            if (row !== monthHeader) {
              row.style.display = isOpen ? 'none' : 'table-row';
            }
          });
          return;
        }

        const editBtn = e.target.closest('[data-edit]');
        const delBtn = e.target.closest('[data-del]');
        if (editBtn) {
          const id = editBtn.dataset.edit;
          const r = appState.records.find(x => x.id === id);
          if (!r) return;
          currentEditId = id;
          $('#rec-open-time').value = r.openTime ? new Date(r.openTime).toLocaleString() : '';
          $('#rec-close-time').value = r.closeTime ? new Date(r.closeTime).toLocaleString() : '';
          $('#rec-iscopy').value = r.isCopy ? 'true' : 'false';
          $('#rec-asset').value = r.symbol || '';
          $('#rec-invest').value = r.capital || 0;
          $('#rec-lev').value = r.leverage || 1;
          $('#rec-side').value = r.direction || 'å¤š';
          $('#rec-strategy-type').value = r.strategy_type || 'S1';
          $('#rec-timeframe').value = r.timeframe || '1h';
          $('#rec-open').value = r.entry_price || 0;
          $('#rec-tp').value = r.tp || 0;
          $('#rec-sl').value = r.sl || 0;
          updateRecRRR();
          $('#rec-closed').value = r.isClosed ? 'æ˜¯' : 'å¦';
          $('#rec-close').value = r.exit_price || 0;
          $('#rec-pl').value = isFinite(+r.profit) ? r.profit : 0;
          $('#rec-fee').value = r.feeRate || 0;
          $('#rec-reason').value = r.comment || '';
          $('#rec-quant-enter').value = r.quantEnter || 'å¦';
          toast('å·²è¼‰å…¥ç´€éŒ„é€²è¡Œä¿®æ”¹');
        }
        if (delBtn) {
          const id = delBtn.dataset.del;
          const idx = appState.records.findIndex(x => x.id === id);
          if (idx >= 0) {
            appState.records.splice(idx, 1);
            persist('ut_records', appState.records);
            renderRecords();
            updateDashboard();
            if (DEBUG_MODE) updateDebugPanel();
            toast('ç´€éŒ„å·²åˆªé™¤');
          }
        }
      });
    }

    // 10. é‡åŒ–æ±ºç­–
    // Kç·š pills
    const pillBox = $('#qt-kline-pills');
    if (pillBox) {
      pillBox.addEventListener('click', (e) => {
        const pill = e.target.closest('.pill');
        if (!pill) return;
        pill.classList.toggle('active');
      });
    }
    safeBind("btn-add-decision", "click", () => {
      const klineTypes = Array.from($('#qt-kline-pills').querySelectorAll('.pill.active')).map(x => x.dataset.value);
      const d = {
        id: Date.now().toString(36) + Math.random().toString(36).slice(2),
        symbol: ($('#qt-asset') ? $('#qt-asset').value : 'BTCUSDT').trim().toUpperCase(),
        pattern: $('#qt-pattern') ? $('#qt-pattern').value : 'æ˜¯',
        trend: $('#qt-trend') ? $('#qt-trend').value : 'ä¸Šè¡Œ',
        market: $('#qt-market') ? $('#qt-market').value : 'æ˜¯',
        breakout: $('#qt-breakout') ? $('#qt-breakout').value : 'æ¿€é€²',
        drawLine: $('#qt-draw') ? $('#qt-draw').value : 'æ˜¯',
        isHot: 'å¦', // è¦æ ¼æ›¸æœªè¦æ±‚ UI æ¬„ä½ï¼Œé è¨­
        kline_types: klineTypes,
        ma: $('#qt-ma') ? $('#qt-ma').value : 'æœªåƒè€ƒ',
        volume: 'æ˜¯', // è¦æ ¼æ›¸æœªè¦æ±‚ UI æ¬„ä½ï¼Œé è¨­
        enter: $('#qt-enter') ? $('#qt-enter').value : 'æ˜¯',
        result: 'æœªåŸ·è¡Œ',
        rrr: parseFloat($('#qt-rrr') ? $('#qt-rrr').value : '1') || 1,
        comment: $('#qt-note') ? $('#qt-note').value : '',
        time: new Date().toISOString()
      };
      appState.decisions.unshift(d);
      persist('ut_decisions', appState.decisions);
      renderQuantTable();
      renderTopCombos();
      if (DEBUG_MODE) updateDebugPanel();
      toast('é‡åŒ–æ±ºç­–å·²å„²å­˜');

      // æ¸…ç©ºè¡¨å–®
      if ($('#qt-asset')) $('#qt-asset').value = 'BTCUSDT';
      if ($('#qt-pattern')) $('#qt-pattern').value = 'æ˜¯';
      if ($('#qt-trend')) $('#qt-trend').value = 'ä¸Šè¡Œ';
      if ($('#qt-market')) $('#qt-market').value = 'æ˜¯';
      if ($('#qt-rrr')) $('#qt-rrr').value = '1.5';
      if ($('#qt-breakout')) $('#qt-breakout').value = 'æ¿€é€²';
      if ($('#qt-draw')) $('#qt-draw').value = 'æ˜¯';
      if ($('#qt-enter')) $('#qt-enter').value = 'æ˜¯';
      if ($('#qt-note')) $('#qt-note').value = '';
      $$('#qt-kline-pills .pill').forEach(p => p.classList.remove('active'));
    });
    safeBind("btn-export-quant-csv", "click", exportQuantCSV);

    // 11. é›²ç«¯è¨­å®š
    if (appState.cloud) {
      if ($('#sb-url')) $('#sb-url').value = appState.cloud.url || '';
      if ($('#sb-key')) $('#sb-key').value = appState.cloud.key || '';
    }
    safeBind("btn-enable-cloud", "click", enableCloud);
    safeBind("btn-disable-cloud", "click", disableCloud);
    initSupabase(); // æª¢æŸ¥ä¸¦åˆå§‹åŒ– Supabase

    // 12. åˆæ¬¡æ¸²æŸ“
    renderRecords();
    updateDashboard();
    updateBalance();
    renderQuantTable();
    renderTopCombos();

    // 13. TV åˆå§‹åŒ–èˆ‡ resize å»æŠ–
    createTVWidget();
    window.addEventListener('resize', (function() {
      let t = null;
      return () => {
        clearTimeout(t);
        t = setTimeout(() => {
          if ($('#p-market') && $('#p-market').style.display !== 'none') createTVWidget();
        }, 200);
      };
    })());

    // 14. è‡ªå‹•é€±å ± (ä¿ç•™åŸæœ‰é‚è¼¯)
    setInterval(() => {
      const now = new Date();
      const y = now.getFullYear(),
        m = ('0' + (now.getMonth() + 1)).slice(-2),
        d = ('0' + now.getDate()).slice(-2);
      const hm = ('0' + now.getHours()).slice(-2) + ':' + ('0' + now.getMinutes()).slice(-2);
      const weekday = now.getDay();
      const todayKey = `${y}-${m}-${d}`;
      if (weekday === 0 && hm === '23:59' && weeklyFlagDate !== todayKey) {
        weeklyFlagDate = todayKey;
        localStorage.setItem('ut_weeklyFlagDate', todayKey);
        const closed = appState.records.filter(r => r.isClosed);
        const wins = closed.filter(r => r.result === 'ç›ˆ').length;
        const losses = closed.filter(r => r.result === 'è™§').length;
        const winrate = (wins + (losses || 0)) ? wins / (wins + losses) * 100 : 0;
        const totalPl = closed.reduce((s, r) => s + (r.profit || 0), 0);
        const rows = [
          ['äº¤æ˜“ç­†æ•¸', 'å‹ç‡(%)', 'ç¸½ç›ˆè™§'],
          [closed.length, winrate.toFixed(1), totalPl.toFixed(2)]
        ];
        const csv = rows.map(r => r.join(',')).join('\n');
        const blob = new Blob(['\ufeff' + csv], {
          type: 'text/csv;charset=utf-8;'
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `UTrader_WeeklyReport_${y}-${m}-${d}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        toast('å·²è‡ªå‹•åŒ¯å‡ºé€±å ±');
      }
    }, 30000);

  } catch (e) {
    console.error("Init error:", e);
  }
}

document.addEventListener("DOMContentLoaded", initApp);
</script>
</body>
</html>
